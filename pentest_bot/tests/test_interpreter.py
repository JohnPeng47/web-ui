from io import StringIO
import contextlib
import builtins

import requests

from pentest_bot.web_exploit.tools.interpreter import PythonInterpreter
from pentest_bot.web_exploit.tools.proxy import TruncatedPrint

def test_request_and_session_proxy():
    interpreter = PythonInterpreter()

    proxied_output = interpreter.run(
        """
import requests
# top-level get
print(requests.get("https://example.com").text[:200])
# session get
sess = requests.Session()
print(sess.get("https://example.com").text[:200])
"""
    )

    real_res = requests.get("https://example.com")

    assert "Example Domain" not in proxied_output
    assert "Example Domain" in real_res.text


def test_filtered_print_truncation_and_prefix():
    # Capture stdout for inspection
    buffer = StringIO()

    # Install the proxy
    proxy = TruncatedPrint(max_len=10)
    original_print = builtins.print
    builtins.print = proxy

    try:
        with contextlib.redirect_stdout(buffer):
            # This line should be truncated
            print("abcdefghijklmnopqrstuvwxyz")
            # This line should be untouched
            print("12345")
    finally:
        # Always restore original print
        builtins.print = original_print

    lines = buffer.getvalue().splitlines()

    assert lines[0] == "abcdefghij"
    assert lines[1] == "---- Your output has been truncated to 10 characters. ----"
    assert lines[2] == "12345"
