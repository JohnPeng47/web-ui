import json
from pydantic import BaseModel
from typing import TypeVar, Type

from cnc.services.queue import BroadcastChannel

T = TypeVar("T", bound=BaseModel)

class PersistedQueue(BroadcastChannel[T]):
    async def fill_from_file(self, file_path: str, model: Type[T]):
        with open(file_path, "r") as f:
            data = json.load(f)
        
        # Convert each item in the data to the specified model and publish to the queue
        for item in data:
            model_instance = model.model_validate(item)
            # print("Publishing to queue: ", model_instance)
            await self.publish(model_instance)