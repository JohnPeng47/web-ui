{
    "reported_to": "Nextcloud",
    "reported_by": "rtod ",
    "title": "Virtual Data Room / Hide download on collabora is easy to bypass",
    "content": "\nSo, let me start with saying I'm not sure if this is a security issue or if it is by design. The reason I'm reporting it here is since Nextcloud promotes this Virtual Data Room a lot.\nhttps://nextcloud.com/blog/nextcloud-announces-virtual-data-room-solution-for-ultimate-protection-of-data-during-sensitive-dealmaking/\nhttps://nextcloud.com/virtual-data-room/\nAnd let me just quote: \"configure Secure View ensure the users can still read and (when shared with editing rights) modify documents, while the documents are watermarked when on screen.\"\n\"With secure view, our online office solutions can be configured to open PDF files, images and text files, making these files available in a watermark-protected way, while downloads and other apps are disabled using File Access Control. This setup is useful when data has to be protected from leaking but still has to be made available for review, as in a virtual data room scenario.\"\nBoth of these claims are false.\nMinimal proof of concept.\nSetup Nextcloud with Collabora\nSetup sercure view & file access control to disallow the download of the files\nShare a document, lets say vdr.odt by public link and mark as hide download\nCopy the link\nNow the point here is that anybody you send the link will only see the watermarked file. Not being able to download or copy data. And of course making a picture of these things is useless as it shows the watermark.\nattacker opens their network tab in the developer tools\nattacker opens the link\nattacker filters on WOPISRC\nAttacker finds a link like\nCode 254 Bytes\n1wss://collabora.server/https%3A%2F%2Fserver%2Findex.php%2Fapps%2Frichdocuments%2Fwopi%2Ffiles%2F1234_abcd%3Faccess_token%3efgh%26access_token_ttl%3D0/ws?WOPISrc=https%3A%2F%2Fserver%2Findex.php%2Fapps%2Frichdocuments%2Fwopi%2Ffiles%2F1234_abcd&compat=/ws\nAs far as I understand the WOPI spec this is us sending the collabora server the WOPI endpoint they have to call. Which in this case is\nhttps://server/index.php/apps/richdocument/wopi/files/1234_abcd\nThe 1234_abcd seems to be the fileid and the instance id\nAnd the access token is also there in the url. In this case efgh.\nNow if an attacker just does the following curl command\nCode 100 Bytes\n1curl https://server/index.php/apps/richdocument/wopi/files/1234_abcd?access_token=efgh -o stolen.odt\nYou will see that they have the unwatermarked version of the data. This is even easier than copying everything over or making photographs.\nImpact\nYour Virtual Data Room is inherently broken. And the claims you make on your website are at best misleading.\nHowever as said I'm not sure if this may be intentional as the feature is called hide download in the UI.\nIn any case. Maybe a good idea would be to have a secret configured on both collabora and the Nextcloud host. Which gets send. So that in case of hide download a client that doesn't know the secret token can't download the file.\nI do not have access to a setup with Only Office. But I believe that to be vulnerable to a similar attack.\n\n",
    "severity": [
        7.7,
        null
    ],
    "bounty": 150,
    "weaknesses": [
        "Improper Access Control - Generic"
    ],
    "screenshots": {},
    "disclosed_date": 1628360880,
    "report_url": "https://hackerone.com/reports/1194606",
    "is_multi_component": true,
    "complexity": "MEDIUM",
    "novelty": "MEDIUM",
    "vuln_category": "WEB_APP",
    "steps": [
        [
            1,
            "Setup Nextcloud with Collabora and configure secure view & file access control to disallow downloads"
        ],
        [
            2,
            "Share a document via public link with 'hide download' enabled, then use developer tools to intercept the WOPISRC URL and download the file directly using curl"
        ]
    ],
    "vuln_description": "The Virtual Data Room's secure view feature in Nextcloud, which is supposed to prevent downloads and display watermarked documents, can be bypassed by intercepting the WOPISRC URL from Collabora and using it to download the original, unwatermarked file directly.",
    "reason": "The vulnerability involves understanding the interaction between Nextcloud's secure view, Collabora's WOPI protocol, and how file access tokens are handled. While the steps to exploit are straightforward once the WOPISRC URL is identified, discovering this requires knowledge of how Collabora integrates with Nextcloud and the WOPI protocol specifics.",
    "new_complexity": "MEDIUM",
    "requires_code": false,
    "requires_CVE": false,
    "is_ctf": false,
    "other_report": null,
    "idor_detectable": true,
    "authnz_byppass_detectable": true,
    "is_simple_payload": false,
    "injection_metadata": {
        "is_simple_payload": true
    },
    "authnz_metadata": {
        "idor_detectable": true,
        "authnz_byppass_detectable": true
    }
}