{
  "reported_to": "Nextcloud",
  "reported_by": "lukasreschkenc ",
  "title": "HEIC image preview can be used to invoke Imagick",
  "content": "\nThe HEIC image preview provider calls into Imagick at https://github.com/nextcloud/server/blob/5d097ddb4b99673f57b8c085dedd93880ee2539d/lib/private/Preview/HEIC.php#L98-L109. This is bad as Imagick processes all kind of image types.\nOne can use this for example to exfiltrate arbitrary files by passing a SVG file that contains a xlink:href to a locally existing file. There are also other concerns with regard to SSRF and XML parsing done by Imagick.\nA super naive example, uploading a file such as \"test.heic\" with this content will render the file \"nextcloud20.png\" inside it. (but you can also reference PDFs, or use it for SSRF, etc etc.\ntest.heic:\nCode 415 Bytes\n1<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n2<svg\n3   xmlns:svg=\"http://www.w3.org/2000/svg\"\n4   xmlns=\"http://www.w3.org/2000/svg\"\n5   xmlns:xlink=\"http://www.w3.org/1999/xlink\"\n6   style=\"overflow: hidden; position: relative;\"\n7   width=\"500\"\n8   height=\"500\">\n9    <image x=\"0\" y=\"0\" width=\"500\" height=\"500\" xlink:href=\"/Users/lukasreschke/Downloads/nextcloud20.png\" stroke-width=\"1\" id=\"image3204\" />\n10</svg>\nPreview:\n<image_0>\nImpact\nGaining access to arbitrary files on the system, SSRF, etc.\n\n",
  "severity": [
    9.0,
    10.0
  ],
  "bounty": null,
  "weaknesses": [
    "Information Disclosure"
  ],
  "screenshots": {
    "image_0": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/yd142zx9bjrpnms000rjwnsktmi3?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_2021-07-14_at_15.21.03.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_2021-07-14_at_15.21.03.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQT4ITYTNW%2F20250325%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250325T005634Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEKD%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIC6h%2BrdYXb2SCjM6RglUQZmdJGtnAEp4YtE6frzu5iOmAiEAmEc2%2Bo0J6oLX1vCnRWFGAVbW7lH%2B6aoT233Nps5VBnIquwUI%2Bf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARADGgwwMTM2MTkyNzQ4NDkiDK%2F1PwnCfCsvULM%2BeSqPBcJ6fpZnxNnO1gFQLrF%2F4yTt3IGOqTr03BGE6%2F5pJY%2Fk6Rl4Mu3bQ1fDPk6K5KUlumLcxSI1Zwz%2FwTUHaHeNQYba2d1%2B8ZOLGhCjfAF4XXnhueAZ7ej%2BY1r23ifUt525NqynE6DhCPR4c7EnJp14LYBHJJpp7W3EnsJeGxPeKOIzwgZYLOE2FwMwg8rursVbjISmeMc7qNnlR0uXS7M8C6hVIxANlM3rWh2kslZpiPopS35xJKpNYX69WWdJ4fSWRYMzglRkwOht7IKgW46gf0rcpO3jxXYBcafvAxrZoTIjSYgOuCAFu%2BWy92kxq8L3djmdOuYBMLa0LoujGB9248wdr2BLsYdvdD0cLe6XhGbkMzDfx0vLF6BoTsGl59rG0e4lVwr6Te2H81DM9ZlPERlzjXTXsfGeDmzHf7SLchHqj4PWImCBAoVO5oKtOhYRho0APNMxvkHA4xB8YQb8hbNqvDCT7nJ97mxGoCObQFU3d%2FOkHWeMoKT5CH%2FQLe0d%2FAnjn4OSj3Ble6%2BCv2LmEBr%2FsOmodDBdQ71jQnqi0mXbbw1mTimS3zADThG2Mjj5tcelm8rBSn6fI96D%2BIIiCJMa8mzYz%2BMVybN9s4%2FQaa2hMyvIbiIwIZUDoOPnNH8DarZ%2FpPkOgyO8jJjuy%2FRH%2FZoUQdAUSARQPpukLHefJDvvHk2VrvYLb%2BYEt3wPCTqAdVynkj6b8EKsj0f9vlAHRI8Z%2BbJYIagix4v67FZoEem9%2F392mdg8Ri7D4JrI290atMQ90ktd4QfHE1hdTlq2WpgMsIrpzgrN%2BJbAnRglh6X%2Bq0MLrTirtRqjS4x9CqQ8WaSi0bzJMoMItxYB0AGCx2u%2F2sUCFLd8dp0C67eDTQgw2%2BCHvwY6sQEtUVhG4aIcJqhsEpdoGtfR3QOgtl%2Fyf2WL%2FXBanc%2FBDE3zYX7shwCfGxHsX%2Fm2Bm4cadboPWoMl5oQzkYPTtuntYVomKFyTBRjwtjPghR7I1%2BvgBW5SGtHeN6%2FSTlu6FVxcSG92%2FvFDnEo3nUJGIUZfTAMQoaa5NpnW82agUdMmewDAvGcWXijVLhn8Mv31YhO3tM%2BCtPlUtKTOOL9gcutQFndEbXSN0kwBdyYsWCUeMo%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=c6f550c0eaa87e18744c3c3921734f54d0489f7681c61d03988477e577101073"
  },
  "disclosed_date": 1673103300,
  "report_url": "https://hackerone.com/reports/1261413",
  "is_multi_component": false,
  "complexity": "MEDIUM",
  "novelty": "MEDIUM",
  "vuln_category": "WEB_APP",
  "steps": [
    [
      1,
      "Upload a malicious HEIC file containing SVG content that references a local file via xlink:href (e.g., 'test.heic' with the provided SVG content)."
    ],
    [
      2,
      "Trigger the HEIC preview generation in Nextcloud, which will process the file using Imagick and render the referenced local file."
    ]
  ],
  "vuln_description": "The vulnerability allows an attacker to exfiltrate arbitrary files from the system by exploiting the HEIC image preview functionality in Nextcloud. The preview provider uses Imagick, which processes various image types, including SVG. By crafting a malicious HEIC file with SVG content that references local files via xlink:href, an attacker can read sensitive files or perform SSRF attacks.",
  "reason": "The attack involves understanding the interaction between HEIC preview generation and Imagick's processing of SVG files. While the steps are straightforward, the vulnerability requires knowledge of how Imagick handles SVG files and the ability to craft a malicious HEIC file that bypasses expected file type constraints.",
  "new_complexity": "MEDIUM",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}