{
  "reported_to": "Rocket.Chat",
  "reported_by": "sonarsource ",
  "title": "Pre-Auth Blind NoSQL Injection leading to Remote Code Execution",
  "content": "\nSummary:\nThe getPasswordPolicy method is vulnerable to NoSQL injection attacks and does not require authentication/authorization. It can be used to take over accounts by leaking password reset tokens. Taking over an admin account leads to Remote Code Execution.\nDescription:\nThe getPasswordPolicy method does not properly validate or sanitize the token parameter and can thus be used to perform a blind NoSQL injection. It can be called without authentication (which seems intended), e.g. by using the /api/v1/method.callAnon API endpoint\nBy using MongoDB's $regex operator, a password reset token can be leaked character by character. Example: in order to check if the password reset token begins with a specific letter, e.g. A, the attacker would send the JSON object {\"$regex\":\"^A\"} as the token parameter. The response contains the server's password policy when the guess was correct, or an error otherwise. This can be repeated for all possible characters and for each position in the token, until the whole token is known. See the pwpolicy_leak_token function in the attached exploit for an implementation of this.\nIn order to take over an account, an attacker would perform the following high-level steps:\nRequest a password reset for the target user's account. This requires the attacker to know the target user's email address.\nLeak the password reset token as explained above\nReset the target user's password to an attacker known one using the password reset token. The target user cannot have email or TOTP 2FA enabled in order for this step to work.\nTo gain Remote Code Execution capabilities on the server, an attacker can follow these steps to take over an admin account. The attacker can then use the newly gained admin privileges to create an incoming web hook that has a script. This allows them to get execute commands or get a shell on the server, because the script is executed on the server without a security boundary in place (which seems to be intended).\nSee pre_auth_nosqli.py for a reference exploit and the attached video for a demonstration of it.\nThe vulnerable code can be found here: getPasswordPolicy.js:8\nReleases Affected:\nTested on 3.12.1\nSeems to be affected since 3.8.0 as the vulnerability was introduced in commit b950f17\nSteps To Reproduce (from initial installation to vulnerability):\nInstall Python3 (required by the exploit)\nInstall the Python dependencies required by the exploit: pip3 install requests\nSet up an instance of RocketChat 3.12.1, e.g. by cloning the repo and using Docker Compose:\ngit clone git@github.com:RocketChat/Rocket.Chat.git\ncd Rocket.Chat\ngit checkout tags/3.12.1\ndocker-compose up -d\nConfigure the instance with default settings, remember the admin's email address (e.g. admin@rocketchat.local)\nDisable all 2FA methods on the admin account\nRun the reference exploit against the instance, provide the admin's email address: python3 pre_auth_nosqli.py 'http://localhost:3000' 'admin@rocketchat.local'\nThe exploit should provide an interactive shell on the the server, use it to verify that you can execute commands as the rocketchat user: whoami\nSupporting Material/References:\nThe attached proof-of-concept video shows the setup and exploitation of a fresh Rocket.Chat instance.\nThis is the exploit's output:\nCode 785 Bytes\n1 ___  ___  _ __   __ _ _ __ ___  ___  _   _ _ __ ___ ___ \n2/ __|/ _ \\| '_ \\ / _` | '__/ __|/ _ \\| | | | '__/ __/ _ \\\n3\\__ \\ (_) | | | | (_| | |  \\__ \\ (_) | |_| | | | (_|  __/\n4|___/\\___/|_| |_|\\__,_|_|  |___/\\___/ \\__,_|_|  \\___\\___|\n5\n6[+] Requesting password reset for \"admin@rocketchat.local\"...\n7[*] Leaking password reset token...\n8[+] Leaked password reset token: 0q9oakr3Lc94p3AnUjtQGlBm4bqJF3AndFYOjIg94ld\n9[+] Resetting password to \"f7c87ed1559f2fe101ee\"...\n10[+] Admin account takeover successful!\n11[+] Creating hook \"backdoor-8624225d\" with secret \"8e2b809f6d1e9c561f9625d362726672\"...\n12[*] Hook: T4nRot8nRvgEDp6rn/6sfs8GYcZCmH7SjKeazsexGmCJjFdLwWMdsqyz9hTcPFYxKF\n13[+] Dropping into shell:\n14$ whoami\n15rocketchat\n16$ id\n17uid=65533(rocketchat) gid=65533(rocketchat) groups=65533(rocketchat)\n18$ \nSuggested mitigation\nEnsure that the user-provided token parameter is a string.\nDisclosure Policy\nAll reported issues are subject to a 90 day disclosure deadline.\nAfter 90 days elapse, parts of the bug report will become visible to the public.\nDon't hesitate to ask if you have any questions or need further help with this issue.\nImpact\nAn attacker can use this vulnerability to target an admin user and take over their account, which is already a high impact. The attacker can then use certain features that are available to admins in order to gain Remote Code Execution capabilities. This is demonstrated in the reference exploit by creating an incoming web hook that executes the attacker's payload in the context of the server process.\nThis gives them complete control over the Rocket.Chat instance and exposes all attached components, e.g. the database or any external system whose credentials are stored within Rocket.Chat settings. An attacker can read, change, or delete all items in the database, impacting confidentiality, integrity and availability.\n\n",
  "severity": [
    9.8,
    null
  ],
  "bounty": null,
  "weaknesses": [
    "None"
  ],
  "screenshots": {},
  "disclosed_date": 1621384560,
  "report_url": "https://hackerone.com/reports/1130721",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "MEDIUM",
  "vuln_category": "API",
  "steps": [
    [
      1,
      "Request a password reset for the target user's account (requires knowing the email address)."
    ],
    [
      2,
      "Exploit the NoSQL injection in the getPasswordPolicy method to leak the password reset token character by character using MongoDB's $regex operator."
    ],
    [
      3,
      "Reset the target user's password using the leaked token (requires the target not to have email or TOTP 2FA enabled)."
    ],
    [
      4,
      "If the target is an admin, create an incoming web hook with a malicious script to gain Remote Code Execution."
    ]
  ],
  "vuln_description": "The getPasswordPolicy method in Rocket.Chat is vulnerable to a pre-authentication blind NoSQL injection via the token parameter. This allows an attacker to leak password reset tokens character by character, leading to account takeover. If an admin account is compromised, it can further lead to Remote Code Execution through web hook abuse.",
  "reason": "The vulnerability involves multiple components (NoSQL injection, password reset flow, web hook feature) and requires understanding of MongoDB's $regex operator for blind injection. However, the attack chain follows a logical sequence once the initial injection point is identified, and the techniques used (NoSQL injection, token brute-forcing) are well-documented.",
  "new_complexity": "MEDIUM",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}