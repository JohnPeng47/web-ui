{
  "reported_to": "GitLab",
  "reported_by": "jobert ",
  "title": "Read files on application server, leads to RCE",
  "content": "\nThe GitLab export upload feature contains a vulnerability that allows an attacker to read arbitrary files on a GitLab instance. This vulnerability is caused by the behaviour of JSON.parse, your error handling, and the possibility to reference a symbolic link in a GitLab export. When I started looking into this functionality, I created a demo repository and created a GitLab export through the project's admin panel. GitLab exports can be imported when creating a new project, for example at https://gitlab.com/projects/new (click GitLab export). Anyway, a simple, extracted GitLab export file contains the following files:\nCode 221 Bytes\n1export $ ls -lash\n2total 48\n3 8 -rw-r--r--@   1 jobert  staff     5B Oct 25 19:52 VERSION\n4 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n5 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json\nWhen the export file is uploaded again, a few things happen. The first three are, in this order: it waits until the file has been written to disk (for big repositories), a version check based on the VERSION file, and creating a new Project model instance based on project.json. The first step isn't important. Lets look at the code that's being executed for the second step (line 12-18 from Gitlab::ImportExport::VersionChecker):\nCode 127 Bytes\n1def check!\n2  version = File.open(version_file, &:readline)\n3  verify_version!(version)\n4rescue => e\n5  shared.error(e)\n6  false\n7end\nPay attention to line 13. It will open the file and call the method readline, which will return the first line of the file. Now, on line 16 any exception is caught and the message is pushed onto the errors array. All these errors are returned to the frontend. Take a look at line 27-31 of the same file:\nCode 222 Bytes\n1if Gem::Version.new(version) != Gem::Version.new(Gitlab::ImportExport.version)\n2  raise Gitlab::ImportExport::Error.new(\"Import version mismatch: Required #{Gitlab::ImportExport.version} but was #{version}\")\n3else\n4  true\n5end\nThis means if the version isn't correct, an exception is returned that contains the provided version from the GitLab export. Lets untar the GitLab export, replace the VERSION file with a symbolic link, and tar the GitLab export again. The structure of the tar will look like this:\nCode 227 Bytes\n1export $ ls -lash\n2 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 VERSION -> /etc/passwd\n3 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n4 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json\nAfter creating a new GitLab export (run tar -czvf test.tar.gz . in the export directory), the new GitLab export can be uploaded. By doing so, the GitLab instance will return the first line of the error because the version matcher raises an exception:\n<image_0>\nHowever, with this only the first line of a file can be read. This is interesting, but much harder to exploit than if an entire file can be read. I kept digging to see if there was a way to read an entire file. Like I pointed out earlier, the third step in the import process is creating a new instance of the Project model. It executes the following code (line 11-22 from Gitlab::ImportExport::ProjectTreeRestorer):\nCode 244 Bytes\n1def restore\n2  json = IO.read(@path)\n3  tree_hash = ActiveSupport::JSON.decode(json)\n4  project_members = tree_hash.delete('project_members')\n5\n6  ActiveRecord::Base.no_touching do\n7    create_relations\n8  end\n9rescue => e\n10  shared.error(e)\n11  false\n12end\nA similar code structure as the version check is implemented: any exception that is thrown in line 13-18 is caught and the error message is pushed onto the errors array. It isn't immediately clear from the code, but the ActiveSupport implementation of JSON decoding uses JSON.parse, which returns the contents of the entire string to be decoded in the error message when it fails to decode. This means that if we can let the decoder raise an exception, we can read the contents of a file. This isn't so hard. Consider this file structure:\nCode 227 Bytes\n1export $ ls -lash\n2 8 -rw-r--r--@   1 jobert  staff    11B Oct 25 20:43 VERSION\n3 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n4 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json -> /etc/passwd\nIn this example, the project.json file is a symlink to /etc/passwd. The IO.read call on line 14 will follow a symlink to read the contents of a file. Obviously, the /etc/passwd file doesn't contain valid JSON, thus it will result in an exception with the contents of /etc/passwd. Use tar to compress the files again to prepare it for upload. An example file is attached: test.tar.gz (F130233). When this file gets imported, it'll show the contents of the linked file in the error message:\n<image_1>\nTo proof that this isn't my own /etc/passwd file that was accidentally compressed with the file, here are the last 5 lines of the /etc/passwd of gitlab.com.\nCode 272 Bytes\n1alejandro:x:1117:1117::/home/alejandro:/bin/bash\n2prometheus:x:999:999::/opt/prometheus:/bin/false\n3gitlab-monitor:x:998:998::/opt/gitlab-monitor:/bin/false\n4postgres:x:116:121:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash\n5brian:x:1118:1118::/home/brian:/bin/bash\nWith this issue, the secrets of the GitLab rails project can be read, too. This results in an RCE because cookies can be marshalled and resigned again. It seems to also give access to the internal GitLab shell tokens, which give access to all repositories.\nLet me know if you need any more information!\n\n",
  "severity": [
    9.0,
    null
  ],
  "bounty": null,
  "weaknesses": [
    "Information Disclosure"
  ],
  "screenshots": {
    "image_0": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/130/235/eda5af808482da6f95d04416ba92d08c11f516d1/Screen_Shot_2016-10-25_at_19.28.51.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2016-10-25_at_19.28.51.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2016-10-25_at_19.28.51.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQRTI3H7PT%2F20250327%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250327T001315Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEND%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIDitAtsoFdKKPtWY7ZwzJyC6Ygq74399ojL1J6nc2feBAiB8BFoRa5XZR8lKAMREvFWlnNcF4u%2FNfJByvS9ozaoSrSqxBQg5EAMaDDAxMzYxOTI3NDg0OSIMSPnhbIxvL3jeA3PxKo4FPE%2FQQ4KUlLmqa67dc6naeIQ0ubDm%2B2lfJp76GtgHFz%2Bq9Iv4pAtQChnfOuFQg%2FNj%2B78Blyd9btcGUCbNkxWsbt1vMvrN1L9t%2FmiMlBCF%2BnWWuAG8ihS%2FQX4JCG2Dl1xqnck%2FjI590JjXO1xeDkDD9NDPH2o5tVYxgyQVKkZ1gAR4hC%2F4jvYJYtkzS0Jbr5NP3Is84teLl2VL2WKBgYFZaDjvxQay%2BEYcPvtBDbGBHSsplECkIkEEjh8kObhZQbwH6icnw7%2BOqBJ4f8RVEpdA3uO5r8794i1%2Ft2O6tvh22n0%2BbFW432R5NMuA3EBQxjaYDupNA6jLbXjma%2FosYlBEuxlTNt4CsA4i5UqSecA13FIcIBgxt8dNDqiKjvCy8%2FEvNS5A2DEzdqm5fHh%2FwsYAUmYU3psRJ7YMZseLo8vqpvVeqICR0z7gGoDxTVfR9ZOn6ILbC2H%2Bjj%2F1OTSZkhkXqZiPIpRkAiAD40lw36KDA%2BaG18l8uSqUkG4HndI15llWp9pcVtxwQWw40x%2BYZJWH%2BtwfogTdQZ6BKQ8FWb0FbmDX5aLIfu%2Fk%2B5KK6z31NJaZjf48ORYJGP5PnLkQbmxrTqcQ7OO%2BXpXmbTB7kSZzTR3r9%2FU%2FSG9bTTeIFOV7gnN71m%2Bximvki5oRfwgF7vNAxZJzkKcDQ%2FeZeTJ5B8dKVofWcxEKxhcsd9r32NGEQ8GZtREmn8AnAzEc1n%2BpaVGexq%2BSvb2Iiv8Rg3hQZpJGpqu%2F4OsRGNA5%2FQOAuk%2F1jtjEDOG1Os6PHZ9KuvSVaHL00P0iX3BZL6vAlDvcQwffKnL5JMu5im9lcOT91NykhMpH9jQzV6KBFanfiE5KtaPdUItQcAHdytcFiHw9ERNNMIugkr8GOrIBbMXfkfOgq5NyzgPhrd%2FiG6aZDDpBBkVScOHbbLszVHS7uZ2Vpe2La4o5i6VUJmc7X20qMrNUR4jwSYvmp9e0IwMJcRDiUf6paDEeVUhY7prTUhq%2BinS%2FRK8L3x158uIJ78xJz4od2tEG0wKf8rOBXDGPP6WDdPb9j7Td2fTT8TKq0zld1xffeAM3PrPyF9wcVIlPMVWrhWtQlSYlFHq5auko6XbvI%2Fwpi83bhOFFq0W77A%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=3356c55e2e0e1945ace1a44fbdfc943d657e9b1f8c29afd74aa49b1061e72869",
    "image_1": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/130/234/3835c6918f985b21fee93e9f9c3401a399c0fd06/Screen_Shot_2016-10-25_at_20.55.36.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2016-10-25_at_20.55.36.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2016-10-25_at_20.55.36.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQRTI3H7PT%2F20250327%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250327T001315Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEND%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIDitAtsoFdKKPtWY7ZwzJyC6Ygq74399ojL1J6nc2feBAiB8BFoRa5XZR8lKAMREvFWlnNcF4u%2FNfJByvS9ozaoSrSqxBQg5EAMaDDAxMzYxOTI3NDg0OSIMSPnhbIxvL3jeA3PxKo4FPE%2FQQ4KUlLmqa67dc6naeIQ0ubDm%2B2lfJp76GtgHFz%2Bq9Iv4pAtQChnfOuFQg%2FNj%2B78Blyd9btcGUCbNkxWsbt1vMvrN1L9t%2FmiMlBCF%2BnWWuAG8ihS%2FQX4JCG2Dl1xqnck%2FjI590JjXO1xeDkDD9NDPH2o5tVYxgyQVKkZ1gAR4hC%2F4jvYJYtkzS0Jbr5NP3Is84teLl2VL2WKBgYFZaDjvxQay%2BEYcPvtBDbGBHSsplECkIkEEjh8kObhZQbwH6icnw7%2BOqBJ4f8RVEpdA3uO5r8794i1%2Ft2O6tvh22n0%2BbFW432R5NMuA3EBQxjaYDupNA6jLbXjma%2FosYlBEuxlTNt4CsA4i5UqSecA13FIcIBgxt8dNDqiKjvCy8%2FEvNS5A2DEzdqm5fHh%2FwsYAUmYU3psRJ7YMZseLo8vqpvVeqICR0z7gGoDxTVfR9ZOn6ILbC2H%2Bjj%2F1OTSZkhkXqZiPIpRkAiAD40lw36KDA%2BaG18l8uSqUkG4HndI15llWp9pcVtxwQWw40x%2BYZJWH%2BtwfogTdQZ6BKQ8FWb0FbmDX5aLIfu%2Fk%2B5KK6z31NJaZjf48ORYJGP5PnLkQbmxrTqcQ7OO%2BXpXmbTB7kSZzTR3r9%2FU%2FSG9bTTeIFOV7gnN71m%2Bximvki5oRfwgF7vNAxZJzkKcDQ%2FeZeTJ5B8dKVofWcxEKxhcsd9r32NGEQ8GZtREmn8AnAzEc1n%2BpaVGexq%2BSvb2Iiv8Rg3hQZpJGpqu%2F4OsRGNA5%2FQOAuk%2F1jtjEDOG1Os6PHZ9KuvSVaHL00P0iX3BZL6vAlDvcQwffKnL5JMu5im9lcOT91NykhMpH9jQzV6KBFanfiE5KtaPdUItQcAHdytcFiHw9ERNNMIugkr8GOrIBbMXfkfOgq5NyzgPhrd%2FiG6aZDDpBBkVScOHbbLszVHS7uZ2Vpe2La4o5i6VUJmc7X20qMrNUR4jwSYvmp9e0IwMJcRDiUf6paDEeVUhY7prTUhq%2BinS%2FRK8L3x158uIJ78xJz4od2tEG0wKf8rOBXDGPP6WDdPb9j7Td2fTT8TKq0zld1xffeAM3PrPyF9wcVIlPMVWrhWtQlSYlFHq5auko6XbvI%2Fwpi83bhOFFq0W77A%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=a5892d55827bd661e9c8052aba383a22bcb15088d2cf875d5f364ac6bb76989b"
  },
  "disclosed_date": 1478147700,
  "report_url": "https://hackerone.com/reports/178152",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "MEDIUM",
  "vuln_category": "WEB_APP",
  "steps": [
    [
      1,
      "Create a GitLab export file containing a symbolic link (symlink) for the VERSION or project.json file pointing to a sensitive file on the server (e.g., /etc/passwd)."
    ],
    [
      2,
      "Upload the malicious GitLab export file to the GitLab instance. The server will attempt to read the symlinked file, triggering an error that exposes the file's contents in the error message."
    ]
  ],
  "vuln_description": "The vulnerability allows an attacker to read arbitrary files on the GitLab server by exploiting symlinks in GitLab export files. This is due to improper handling of file reads and error messages during the import process, which can expose sensitive data like /etc/passwd or Rails secrets.",
  "reason": "The attack involves multiple components (symlink manipulation, error handling, JSON parsing) and requires understanding subtle interactions between file handling and error messages. The attacker must also recognize the opportunity to exploit JSON.parse error messages for file disclosure, which is non-obvious.",
  "new_complexity": "HIGH",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}