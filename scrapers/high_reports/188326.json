{
  "reported_to": "shopify-scripts",
  "reported_by": "haquaman ",
  "title": "Buffer overflow in mrb_time_asctime",
  "content": "\nHi,\nThis one doesn't always crash every time, but with ASAN on it will.\nCrash file is:\nCode 28 Bytes\n1Time.new-0XD00000000000000&0\nBut you could always do Time.at(sec,usec) with special values, and basically anything that gets to_s called (mrb_time_asctime in C) (in this case, no method found exception does this).\nCrashes sometimes in mruby:\nCode 51 Bytes\n1 $ ./dev/bin/mruby crash.rb\n2Segmentation fault: 11\n3\nThe times it doesn't crash, it could either return strings outside of memory with a buffer-overead. Some of the lldb runs shows this:\nCode 5.86 KiB\n1$ lldb ./dev/bin/mruby crash.rb\n2(lldb) target create \"./dev/bin/mruby\"\n3Current executable set to './dev/bin/mruby' (x86_64).\n4(lldb) settings set -- target.run-args  \"crash.rb\"\n5(lldb) r\n6Process 66222 launched: './dev/bin/mruby' (x86_64)\n7trace:\n8        [0] crash.rb:1\n9crash.rb:1: undefined method '&' for Sun  00 16:03:04 1901 (NoMethodError)\n10Process 66222 exited with status = 1 (0x00000001)\n11(lldb) r\n12Process 66665 launched: './dev/bin/mruby' (x86_64)\n13trace:\n14        [0] crash.rb:1\n15crash.rb:1: undefined method '&' for Sun Jan 00 16:03:04 1900 (NoMethodError)\n16Process 66665 exited with status = 1 (0x00000001)\n17(lldb) r\n18Process 66889 launched: './dev/bin/mruby' (x86_64)\n19trace:\n20        [0] crash.rb:1\n21crash.rb:1: undefined method '&' for Sun Jan 00 16:03:04 1900 (NoMethodError)\n22Process 66889 exited with status = 1 (0x00000001)\n23(lldb) r\n24Process 67075 launched: './dev/bin/mruby' (x86_64)\n25trace:\n26        [0] crash.rb:1\n27crash.rb:1: undefined method '&' for Sun Jan 01 16:03:04 1900 (NoMethodError)\n28Process 67075 exited with status = 1 (0x00000001)\n29(lldb) r\n30Process 67127 launched: './dev/bin/mruby' (x86_64)\n31trace:\n32        [0] crash.rb:1\n33crash.rb:1: undefined method '&' for Sun _defined? 486 16:03:04 2259 (NoMethodError)\n34Process 67127 exited with status = 1 (0x00000001)\n35(lldb) r\n36Process 67341 launched: './dev/bin/mruby' (x86_64)\n37trace:\n38        [0] crash.rb:1\n39crash.rb:1: undefined method '&' for Sun Jan 04 16:03:04 1900 (NoMethodError)\n40Process 67341 exited with status = 1 (0x00000001)\n41(lldb) r\n42Process 67904 launched: './dev/bin/mruby' (x86_64)\n43trace:\n44        [0] crash.rb:1\n45crash.rb:1: undefined method '&' for Sun Jan 00 16:03:04 1900 (NoMethodError)\n46Process 67904 exited with status = 1 (0x00000001)\n47(lldb) r\n48Process 68098 launched: './dev/bin/mruby' (x86_64)\n49trace:\n50        [0] crash.rb:1\n51crash.rb:1: undefined method '&' for Sun Jan 00 16:03:04 1900 (NoMethodError)\n52Process 68098 exited with status = 1 (0x00000001)\n53(lldb) r\n54Process 68320 launched: './dev/bin/mruby' (x86_64)\n55trace:\n56        [0] crash.rb:1\n57crash.rb:1: undefined method '&' for Sun  01 16:03:04 1900 (NoMethodError)\n58Process 68320 exited with status = 1 (0x00000001)\n59(lldb) r\n60Process 68514 launched: './dev/bin/mruby' (x86_64)\n61trace:\n62        [0] crash.rb:1\n63crash.rb:1: undefined method '&' for Sun Jan 00 16:03:04 1900 (NoMethodError)\n64Process 68514 exited with status = 1 (0x00000001)\n65(lldb) r\n66Process 68628 launched: './dev/bin/mruby' (x86_64)\n67trace:\n68        [0] crash.rb:1\n69crash.rb:1: undefined method '&' for Sun ) 62 16:03:04 1983 (NoMethodError)\n70Process 68628 exited with status = 1 (0x00000001)\n71(lldb) r\n72Process 68870 launched: './dev/bin/mruby' (x86_64)\n73trace:\n74        [0] crash.rb:1\n75crash.rb:1: undefined method '&' for Sun  00 16:03:04 1901 (NoMethodError)\n76Process 68870 exited with status = 1 (0x00000001)\n77(lldb) r\n78Process 68908 launched: './dev/bin/mruby' (x86_64)\n79trace:\n80        [0] crash.rb:1\n81crash.rb:1: undefined method '&' for Sun  01 16:03:04 1901 (NoMethodError)\n82Process 68908 exited with status = 1 (0x00000001)\n83(lldb) r\n84Process 69130 launched: './dev/bin/mruby' (x86_64)\n85trace:\n86        [0] crash.rb:1\n87crash.rb:1: undefined method '&' for Sun Jan 00 16:03:04 1900 (NoMethodError)\n88Process 69130 exited with status = 1 (0x00000001)\n89(lldb) r\n90Process 69324 launched: './dev/bin/mruby' (x86_64)\n91Process 69324 stopped\n92* thread #1: tid = 0x88a312d, 0x00007fff95b0e152 libsystem_c.dylib`strlen + 18, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x14010ef30)\n93    frame #0: 0x00007fff95b0e152 libsystem_c.dylib`strlen + 18\n94libsystem_c.dylib`strlen:\n95->  0x7fff95b0e152 <+18>: pcmpeqb (%rdi), %xmm0\n96    0x7fff95b0e156 <+22>: pmovmskb %xmm0, %esi\n97    0x7fff95b0e15a <+26>: andq   $0xf, %rcx\n98    0x7fff95b0e15e <+30>: orq    $-0x1, %rax\n99(lldb) bt\n100* thread #1: tid = 0x88a312d, 0x00007fff95b0e152 libsystem_c.dylib`strlen + 18, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x14010ef30)\n101  * frame #0: 0x00007fff95b0e152 libsystem_c.dylib`strlen + 18\n102    frame #1: 0x00007fff95b53a54 libsystem_c.dylib`__vfprintf + 5713\n103    frame #2: 0x00007fff95b7c6c9 libsystem_c.dylib`__v2printf + 669\n104    frame #3: 0x00007fff95b60915 libsystem_c.dylib`_vsnprintf + 596\n105    frame #4: 0x00007fff95b609ca libsystem_c.dylib`vsnprintf + 80\n106    frame #5: 0x00007fff95b91d08 libsystem_c.dylib`__snprintf_chk + 128\n107    frame #6: 0x000000010004f15a mruby`mrb_time_asctime + 282\n108    frame #7: 0x000000010003cf0b mruby`mrb_funcall_with_block + 1515\n109    frame #8: 0x000000010003c901 mruby`mrb_funcall_argv + 113\n110    frame #9: 0x000000010000c023 mruby`mrb_method_missing + 275\n111    frame #10: 0x000000010000da7b mruby`mrb_bob_missing + 123\n112    frame #11: 0x000000010003fc13 mruby`mrb_vm_exec + 6739\n113    frame #12: 0x000000010003e1a7 mruby`mrb_vm_run + 135\n114    frame #13: 0x0000000100046604 mruby`mrb_top_run + 100\n115    frame #14: 0x0000000100071adf mruby`load_exec + 1183\n116    frame #15: 0x0000000100071623 mruby`mrb_load_file_cxt + 67\n117    frame #16: 0x00000001000017d8 mruby`main + 904\n118    frame #17: 0x00007fff8a9db5ad libdyld.dylib`start + 1\n119(lldb) register read\n120General Purpose Registers:\n121       rax = 0x00000000ffffffff\n122       rbx = 0x00000000ffffffff\n123       rcx = 0x000000014010ef38\n124       rdx = 0x000000014010ef38\n125       rdi = 0x000000014010ef30\n126       rsi = 0x00007fff95b52eb9  libsystem_c.dylib`__vfprintf + 2742\n127       rbp = 0x00007fff5fbfbca0\n128       rsp = 0x00007fff5fbfbca0\n129        r8 = 0x0000000000000003\n130        r9 = 0x000000010007f803  \"%s %02d %02d:%02d:%02d %s%d\"\n131       r10 = 0x00007fffa10cd401\n132       r11 = 0x00007ffe5fb713a0\n133       r12 = 0x000000010007f805  \" %02d %02d:%02d:%02d %s%d\"\n134       r13 = 0x0000000000000073\n135       r14 = 0x0000000000000073\n136       r15 = 0x0000000000000003\n137       rip = 0x00007fff95b0e152  libsystem_c.dylib`strlen + 18\n138    rflags = 0x0000000000010206\n139        cs = 0x000000000000002b\n140        fs = 0x0000000000000000\n141        gs = 0x0000000000000000\n142\n143(lldb) q\n144Quitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n145\nWith some symbols compiled in:\nCode 3.38 KiB\n1$ lldb ./mruby/bin/mruby crash.rb\n2(lldb) target create \"./mruby/bin/mruby\"\n3Current executable set to './mruby/bin/mruby' (x86_64).\n4(lldb) settings set -- target.run-args  \"crash.rb\"\n5(lldb) r\n6Process 1457 launched: './mruby/bin/mruby' (x86_64)\n7Process 1457 stopped\n8* thread #1: tid = 0x88ab040, 0x00007fff95b0e152 libsystem_c.dylib`strlen + 18, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x101946780)\n9    frame #0: 0x00007fff95b0e152 libsystem_c.dylib`strlen + 18\n10libsystem_c.dylib`strlen:\n11->  0x7fff95b0e152 <+18>: pcmpeqb (%rdi), %xmm0\n12    0x7fff95b0e156 <+22>: pmovmskb %xmm0, %esi\n13    0x7fff95b0e15a <+26>: andq   $0xf, %rcx\n14    0x7fff95b0e15e <+30>: orq    $-0x1, %rax\n15(lldb) up\n16frame #1: 0x00007fff95b53a54 libsystem_c.dylib`__vfprintf + 5713\n17libsystem_c.dylib`__vfprintf:\n18    0x7fff95b53a54 <+5713>: movq   %rax, -0x2f8(%rbp)\n19    0x7fff95b53a5b <+5720>: movb   $0x0, -0x18f(%rbp)\n20    0x7fff95b53a62 <+5727>: movl   $0x0, -0x304(%rbp)\n21    0x7fff95b53a6c <+5737>: movl   %r14d, %r13d\n22(lldb) up\n23frame #2: 0x00007fff95b7c6c9 libsystem_c.dylib`__v2printf + 669\n24libsystem_c.dylib`__v2printf:\n25    0x7fff95b7c6c9 <+669>: movl   %eax, %ebx\n26    0x7fff95b7c6cb <+671>: jmp    0x7fff95b7c718            ; <+748>\n27    0x7fff95b7c6cd <+673>: callq  0x7fff95b91fe4            ; symbol stub for: __error\n28    0x7fff95b7c6d2 <+678>: movl   (%rax), %ebx\n29(lldb) up\n30frame #3: 0x00007fff95b60915 libsystem_c.dylib`_vsnprintf + 596\n31libsystem_c.dylib`_vsnprintf:\n32    0x7fff95b60915 <+596>: testq  %rbx, %rbx\n33    0x7fff95b60918 <+599>: je     0x7fff95b60924            ; <+611>\n34    0x7fff95b6091a <+601>: movq   -0x1e0(%rbp), %rcx\n35    0x7fff95b60921 <+608>: movb   $0x0, (%rcx)\n36(lldb) up\n37frame #4: 0x00007fff95b609ca libsystem_c.dylib`vsnprintf + 80\n38libsystem_c.dylib`vsnprintf:\n39    0x7fff95b609ca <+80>: addq   $0x10, %rsp\n40    0x7fff95b609ce <+84>: popq   %rbx\n41    0x7fff95b609cf <+85>: popq   %r12\n42    0x7fff95b609d1 <+87>: popq   %r14\n43(lldb) up\n44frame #5: 0x00007fff95b91d08 libsystem_c.dylib`__snprintf_chk + 128\n45libsystem_c.dylib`__snprintf_chk:\n46    0x7fff95b91d08 <+128>: cmpq   -0x10(%rbp), %rbx\n47    0x7fff95b91d0c <+132>: jne    0x7fff95b91d1d            ; <+149>\n48    0x7fff95b91d0e <+134>: addq   $0xd8, %rsp\n49    0x7fff95b91d15 <+141>: popq   %rbx\n50(lldb)\n51frame #6: 0x000000010004e8da mruby`mrb_time_asctime(mrb=0x00000001002029f0, self=mrb_value @ 0x00007fff5fbfc530) + 282 at time.c:506\n52   503\n53   504    tm = DATA_GET_PTR(mrb, self, &mrb_time_type, struct mrb_time);\n54   505    d = &tm->datetime;\n55-> 506    len = snprintf(buf, sizeof(buf), \"%s %s %02d %02d:%02d:%02d %s%d\",\n56   507      wday_names[d->tm_wday], mon_names[d->tm_mon], d->tm_mday,\n57   508      d->tm_hour, d->tm_min, d->tm_sec,\n58   509      tm->timezone == MRB_TIMEZONE_UTC ? \"UTC \" : \"\",\n59(lldb) p *tm\n60(mrb_time) $0 = {\n61  sec = -936748721012153088\n62  usec = 105092\n63  timezone = MRB_TIMEZONE_LOCAL\n64  datetime = {\n65    tm_sec = 12\n66    tm_min = 5\n67    tm_hour = 16\n68    tm_mday = 1\n69    tm_mon = 6484120\n70    tm_year = 1\n71    tm_wday = 0\n72    tm_yday = 1\n73    tm_isdst = 0\n74    tm_gmtoff = 1701667182\n75    tm_zone = 0x000a000000000000 <no value available>\n76  }\n77}\n78(lldb) p *d\n79(tm) $1 = {\n80  tm_sec = 12\n81  tm_min = 5\n82  tm_hour = 16\n83  tm_mday = 1\n84  tm_mon = 6484120\n85  tm_year = 1\n86  tm_wday = 0\n87  tm_yday = 1\n88  tm_isdst = 0\n89  tm_gmtoff = 1701667182\n90  tm_zone = 0x000a000000000000 <no value available>\n91}\n92(lldb) q\n93Quitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n94\nPatch to fix would be this:\nCode 523 Bytes\n1diff --git a/mrbgems/mruby-time/src/time.c b/mrbgems/mruby-time/src/time.c\n2index dfd4450..5dc5b34 100644\n3--- a/mrbgems/mruby-time/src/time.c\n4+++ b/mrbgems/mruby-time/src/time.c\n5@@ -238,7 +238,9 @@ time_alloc(mrb_state *mrb, double sec, double usec, enum mrb_timezone timezone)\n6     tm->usec -= 1000000;\n7   }\n8   tm->timezone = timezone;\n9-  mrb_time_update_datetime(tm);\n10+  if (!mrb_time_update_datetime(tm)) {\n11+    mrb_raisef(mrb, E_ARGUMENT_ERROR, \"%S out of Time range\", mrb_float_value(mrb, sec));\n12+  }\n13 \n14   return tm;\n15 }\nWhich now returns:\nCode 119 Bytes\n1$ ./mruby/bin/mruby crash.rb\n2        [0] crash.rb:1\n3crash.rb:1: -9.3674872101215e+17 out of Time range (ArgumentError)\n4\nAlso affected mruby-engine:\nCode 2.42 KiB\n1$ ./bin/sandbox crash.rb\n2./bin/sandbox:20: [BUG] Segmentation fault at 0x0000014531cca0\n3ruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin15]\n4\n5-- Crash Report log information --------------------------------------------\n6   See Crash Report log file under the one of following:\n7     * ~/Library/Logs/CrashReporter\n8     * /Library/Logs/CrashReporter\n9     * ~/Library/Logs/DiagnosticReports\n10     * /Library/Logs/DiagnosticReports\n11   for more details.\n12Don't forget to include the above Crash Report log file in bug reports.\n13\n14-- Control frame information -----------------------------------------------\n15c:0003 p:---- s:0011 e:000010 CFUNC  :sandbox_eval\n16c:0002 p:0214 s:0006 E:000c80 EVAL   ./bin/sandbox:20 [FINISH]\n17c:0001 p:0000 s:0002 E:001810 (none) [FINISH]\n18\n19-- Ruby level backtrace information ----------------------------------------\n20./bin/sandbox:20:in `<main>'\n21./bin/sandbox:20:in `sandbox_eval'\n22\n23-- Machine register context ------------------------------------------------\n24 rax: 0x00000000ffffffff rbx: 0x00000000ffffffff rcx: 0x000000014531cca0\n25 rdx: 0x000000014531cca0 rdi: 0x000000014531cca0 rsi: 0x00007fff95b52eb9\n26 rbp: 0x00007fff528d0400 rsp: 0x00007fff528d0400  r8: 0x0000000000000003\n27  r9: 0x000000010dd2a24a r10: 0x00007fffa10cd401 r11: 0x00007ffe44bac7b4\n28 r12: 0x000000010dd2a24c r13: 0x0000000000000073 r14: 0x0000000000000073\n29 r15: 0x0000000000000003 rip: 0x00007fff95b0e152 rfl: 0x0000000000010206\n30\n31-- C level backtrace information -------------------------------------------\n320   ruby                                0x000000010d4cb5d4 rb_vm_bugreport + 388\n331   ruby                                0x000000010d36d023 rb_bug_context + 483\n342   ruby                                0x000000010d440653 sigsegv + 83\n353   libsystem_platform.dylib            0x00007fff9826d52a _sigtramp + 26\n364   libsystem_c.dylib                   0x00007fff95b0e152 strlen + 18\n375   ???                                 0x00007fff528d07f0 0x0 + 140734578362352\n38\n39-- Other runtime information -----------------------------------------------\n40\n41* Loaded script: ./bin/sandbox\n42\n43* Loaded features:\n44\n45    0 enumerator.so\n46    1 thread.rb\n47    2 rational.so\n48    3 complex.so\n49<snip various gems>\n50  185 /Users/<snip>/mruby-engine/lib/mruby_engine/mruby_engine.bundle\n51  186 /Users/<snip>/mruby-engine/lib/mruby_engine.rb\n52\n53[NOTE]\n54You may have encountered a bug in the Ruby interpreter or extension libraries.\n55Bug reports are welcome.\n56For details: http://www.ruby-lang.org/bugreport.html\n57\n58Abort trap: 6\n59\nPatch to fix mruby-engine:\nCode 559 Bytes\n1diff --git a/ext/mruby_engine/mruby-time/src/time.c b/ext/mruby_engine/mruby-time/src/time.c\n2index 8884a5d..2b5d770 100644\n3--- a/ext/mruby_engine/mruby-time/src/time.c\n4+++ b/ext/mruby_engine/mruby-time/src/time.c\n5@@ -236,7 +236,9 @@ time_alloc(mrb_state *mrb, double sec, double usec, enum mrb_timezone timezone)\n6     tm->usec -= 1000000;\n7   }\n8   tm->timezone = timezone;\n9-  mrb_time_update_datetime(tm);\n10+  if (!mrb_time_update_datetime(tm)) {\n11+    mrb_raisef(mrb, E_ARGUMENT_ERROR, \"%S out of Time range\", mrb_float_value(mrb, sec));\n12+  }\n13 \n14   return tm;\n15 }\nNow returns:\nCode 176 Bytes\n1$ ./bin/sandbox crash.rb\n2./bin/sandbox:20:in `sandbox_eval': -9.3674872249306e+17 out of Time range (MRubyEngine::EngineRuntimeError)\n3        from ./bin/sandbox:20:in `<main>'\n4\nCheers,\nHugh\n\n",
  "severity": [
    7.0,
    8.9
  ],
  "bounty": 10000,
  "weaknesses": [
    "Uncontrolled Resource Consumption"
  ],
  "screenshots": {},
  "disclosed_date": 1482085320,
  "report_url": "https://hackerone.com/reports/188326",
  "is_multi_component": true,
  "complexity": "MEDIUM",
  "novelty": "MEDIUM",
  "vuln_category": "CODE",
  "steps": [
    [
      1,
      "Create a Time object with invalid values using Time.new(-0XD00000000000000&0) or Time.at(sec, usec) with special values"
    ],
    [
      2,
      "Call to_s method on the Time object, which triggers mrb_time_asctime in C"
    ]
  ],
  "vuln_description": "A buffer overflow vulnerability in mrb_time_asctime function in mruby's Time implementation. When processing specially crafted Time objects with invalid values, it can cause segmentation faults or return strings from outside memory boundaries due to buffer over-reads.",
  "reason": "The vulnerability requires understanding of mruby's Time implementation and how to craft invalid Time objects, but the core issue (buffer overflow from unchecked values) is a common class of vulnerability. The attack vector is straightforward once the invalid Time object creation is understood.",
  "new_complexity": "MEDIUM",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}