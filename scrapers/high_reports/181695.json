{
  "reported_to": "shopify-scripts",
  "reported_by": "h72 ",
  "title": "Undefined method_missing null pointer dereference",
  "content": "\nIt's possible to segfault mruby by undefining BasicObject#method_missing in certain cases.\nThere is a fallback methodmissing C function (mrb_method_missing) which is called in _some cases when the VM fails to look up the method_missing method:\nBasicObject.remove_method(:method_missing); 1.foo\nNoMethodError: undefined method 'foo' for 1\nHowever the mrb_method_missing fallback is not consistently used.\nKernel#__send__ calls into mrb_funcall_with_block in vm.c, which contains the following code at line 362 (as of commit 88604e39ac9c25ffdad2e3f03be26516fe866038):\nc = mrb_class(mrb, self);\np = mrb_method_search_vm(mrb, &c, mid);\nif (!p) {\nundef = mid;\nmid = mrb_intern_lit(mrb, \"method_missing\");\np = mrb_method_search_vm(mrb, &c, mid);\nn++; argc++;\n}\nIf the method search for method_missing fails, p will be a null pointer. Further down on line 380, p is tested with MRB_PROC_CFUNC_P, which deferences p.\nThis segfault can be reproduced with the following code:\nBasicObject.remove_method(:method_missing)\n1.send(:foo)\nThe method search logic in the OP_SUPER instruction is also buggy. The same bug can be triggered through OP_SUPER with the following code:\nBasicObject.remove_method(:method_missing)\nclass A\ndef foo\nsuper\nend\nend\nA.new.foo\nI'm not familiar enough with the mruby VM internals to write a patch for this. It should just be a matter of making sure mrb_method_missing is called if a method_missing method search fails (as the logic in OP_SEND instruction does).\n\n",
  "severity": [
    7.0,
    8.9
  ],
  "bounty": 8000,
  "weaknesses": [
    "Uncontrolled Resource Consumption"
  ],
  "screenshots": {},
  "disclosed_date": 1481954580,
  "report_url": "https://hackerone.com/reports/181695",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "MEDIUM",
  "vuln_category": "CODE",
  "steps": [
    [
      1,
      "BasicObject.remove_method(:method_missing)"
    ],
    [
      2,
      "1.send(:foo)"
    ]
  ],
  "vuln_description": "The vulnerability is a null pointer dereference in mruby when BasicObject#method_missing is undefined. The fallback method mrb_method_missing is not consistently used, leading to a segfault when the method search for method_missing fails and the null pointer is dereferenced.",
  "reason": "The vulnerability requires understanding of mruby's method lookup mechanism and the interaction between method_missing and the fallback C function. However, the steps to reproduce are straightforward once the underlying issue is known.",
  "new_complexity": "MEDIUM",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}