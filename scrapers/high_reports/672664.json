{
  "reported_to": "BlockDev Sp. Z o.o",
  "reported_by": "lucash-dev ",
  "title": "Steal collateral during `end` process, by earning DSR interest after `flow`.",
  "content": "\nSummary:\nThe end contract in MCD controls the process of shutting down\nthe MCD contracts and allowing for users to redeem their DAI for\ncollateral -- presumably to migrate to a new implementation of DAI.\nThe process, however, doesn't prevent the continued functioniong\nof DAI savings accounts (pot contract), which allows for continued\nminting of DAI after all other contracts have been \"caged\", resulting\nin theft (possibly involuntary) of collateral.\nDetailed Description\nThe end contract is responsible for orchestrating the complex sequence\nof steps for shutting down the MCD eco-system, settling all existing DAI\ninto collateral during the process.\nThe first step in the process is the method cage, which ensures that other\nMCD contracts stop operating in the normal way, and enter a \"not-live\" mode.\nIn particular, the vat contract is updated to prevent the creation of new\nCDP's, and also prevents the accrual of interest (vat.fold). This is obtained by\ncalling the cage method in the vat contract.\nPuzzingly, however, the end.cage method doesn't affect the state of the pot\n(savings account) contract, allowing for interests to be continuously earned\n-- and new DAI to be minted --indefinitely during all the phases of the end\nprocess. Most significantly, it allows a user to mint new DAI even after the\nfinal DAI/collateral rate has been fixed (end.flow).\nThe consequence is that it's possible to inflate the DAI supply so that there\nisn't enough collateral for all of it to be redeemed. In that case the last\nusers to try to redeem will have their collateral stolen by the faster ones, as\nthey might well be unable to redeem any DAI at all.\nAn example might help clarify the problem:\nSuppose there are two users, Ali and Bob, who each control 50% percent of the\nDAI supply, lets say 10 DAI each.\nNow let's assume the end process is initiated and proceeds as usual --\neventually reaching the flow stage, with a fixed exchange rate of 1 DAI / ETH.\nLet's also assume that there is a DSR rate of 100% a month (unrealistic, but makes\nthe numbers easier).\nAfter the end.flow is called, Ali notices that the he can still use pot to earn\ninterests, so he deposits all his DAI in pot. Meanwhile Bob can't do the same\nas his funds are locked inside a Dapp (let's say an Augur market).\nAfter one month, Ali calls pot.exit and gets back 20 DAI. That corresponds to\nthe total original supply of DAI before end.flow was called. So, Ali calls\nend.pack and end.cash to convert his 20 DAI into 20 ETH -- all the collateral\nin the MCD contracts.\nWhen Bob tries to redeem his DAI, there is no collateral left. His end.cash\ncalls fail and he ends up with no tokens -- DAI or ETH -- at all.\nSteps to Reproduce\nI've attached to this report a version of end.t.sol that adds a test scenario\n(test_steal_collateral_using_dsr_after_thaw) to reproduce this attack (in fact, the example above).\nPlease don't hesitate to contact me if you need more help reproducing it.\nPossible Remediation\nThe issue could be completely prevented by introducing a cage functionality into\nthe pot contract, and not allowing the pot.drip method to be called when\nnot in live mode.\nPlease note that the above solution is provided as proof that the reported issue\nis fixable. I make no claim that the above is the best available solution.\nImpact\nPlease refer to the \"Impact Analysis\" field for more details.\nFinal Note\nPlease don't hesitate to contact me if you need any further clarification around\nthis issue, or help reproducing and evaluating it.\nImpact\nImpact Analysis\nAs clearly demonstrated above, the reported bug can be used to steal collateral\nfrom the end contract. Even more disturbingly, the bug can likely cause users\nthat own DSR deposits to unwittingly steal collateral in case of a shutdown.\nLet's evaluate how much collateral can be stolen in this scenarios. The amount\nstolen depends on three factors:\n1 - DSR savings rate.\n2 - Portion of DAI kept in DSR deposits.\n3 - Time distribution of users calling end.pack.\nIt's impossible to know beforehand either. But we can make educated guesses\nabout a worst-case scenario.\nIt's possible that the DSR rate will be set at a high value at some point.\nConsidering that the previous incarnation of DAI saw a the CDP rate reach\n25% at some point, it's definitely possible for DSR to reach a slightly lower\nrate, say 20%. Furthermore, it's likely all users (including Dapps) will keep\ntheir DAI holdings in DSR deposits, doing so has a possible upside, and minimal\ngas costs.\nAs for the time-distribution of users redeeming their DAI, it's again entirely\npossible that a large portion of the DAI supply will be used to interact with\nDapps rather than held speculatively. Augur V2, for example, has plans to use\nDAI for making bets on prediction markets. Since these markets might take\nquite a long time to be resolved -- up to several months -- it's unlikely\nthat a DAI shutdown would cause an immediate withdrawal of DAI by Augur users\n-- if the reported vulnerability isn't known.\nOther Dapps might well have similar characteristics, though it's again impossible\nto know beforehand.\nGiven the above -- DSR rates up to 20% and most of DAI locked in DSR deposits\ninside Dapps for months -- it's perfectly possible that the bug leads to\na loss of 10% or more of the collateral in the MCD contracts.\nThat scenario might happen even without an intentional attack.\n\n",
  "severity": [
    7.0,
    8.9
  ],
  "bounty": 25000,
  "weaknesses": [
    "Business Logic Errors"
  ],
  "screenshots": {},
  "disclosed_date": 1568062200,
  "report_url": "https://hackerone.com/reports/672664",
  "is_multi_component": true,
  "complexity": "HIGH",
  "novelty": "HIGH",
  "vuln_category": "CODE",
  "steps": [
    [
      1,
      "Initiate the end process by calling end.cage, which cages the vat contract but leaves the pot contract uncaged."
    ],
    [
      2,
      "After end.flow is called to fix the DAI/collateral exchange rate, continue to earn DSR interest by depositing DAI into the pot contract."
    ],
    [
      3,
      "Call pot.exit to withdraw the increased DAI balance due to accrued interest."
    ],
    [
      4,
      "Use end.pack and end.cash to redeem the inflated DAI supply for collateral, leaving insufficient collateral for other users."
    ]
  ],
  "vuln_description": "The vulnerability allows a user to continue earning DSR interest after the end process has fixed the DAI/collateral exchange rate, enabling them to inflate their DAI balance and redeem more collateral than originally entitled, at the expense of other users.",
  "reason": "This vulnerability involves understanding the complex interactions between the end, vat, and pot contracts during the shutdown process. The attacker must recognize that the pot contract remains functional after the vat is caged, allowing DSR interest to accrue even after the exchange rate is fixed. This requires deep knowledge of the MCD system's shutdown mechanics and the subtle oversight in not caging the pot contract.",
  "new_complexity": "HIGH",
  "requires_code": true,
  "requires_CVE": false,
  "is_ctf": false,
  "other_report": null
}